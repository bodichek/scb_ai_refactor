{% extends "base.html" %}
{% load static %}

{% block title %}Coach Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-xl-10">
      
      <!-- Header s v√Ωbƒõrem klienta -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h1 class="h3 mb-0 text-dark fw-bold">
                <i class="fas fa-users-cog text-primary me-2"></i>
                Coach Dashboard
              </h1>
              <p class="text-muted mb-0 mt-1">Spr√°va a monitoring klient≈Ø</p>
            </div>
            <div class="col-md-4">
              <div class="position-relative">
                <div class="input-group">
                  <span class="input-group-text bg-light border-end-0">
                    <i class="fas fa-search text-muted"></i>
                  </span>
                  <input type="text" 
                         id="clientSearchInput" 
                         class="form-control border-start-0 bg-light" 
                         placeholder="Vyhledejte klienta podle n√°zvu firmy nebo jm√©na..."
                         autocomplete="off">
                  <span class="input-group-text bg-light border-start-0" style="cursor: pointer;" id="dropdownIndicator">
                    <i class="fas fa-chevron-down text-muted"></i>
                  </span>
                </div>
                
                <!-- Dropdown s v√Ωsledky vyhled√°v√°n√≠ -->
                <div id="searchResults" class="position-absolute w-100 bg-white border rounded shadow-sm mt-1" style="display: none; z-index: 1000; max-height: 300px; overflow-y: auto;">
                  <!-- V√Ωsledky se naƒçtou dynamicky -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Klientsk√© info (skryt√© na zaƒç√°tku) -->
      <div id="clientInfoSection" class="card border-0 shadow-sm mb-4" style="display: none;">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="d-flex align-items-center">
                <div class="avatar-lg bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center me-3">
                  <i class="fas fa-building text-white fs-4"></i>
                </div>
                <div>
                  <h4 id="clientCompanyName" class="mb-1 fw-bold">-</h4>
                  <p id="clientContactInfo" class="text-muted mb-0">-</p>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="row g-3">
                <div class="col-6 col-sm-3">
                  <div class="text-center">
                    <div id="clientStatsDocuments" class="h5 mb-0 text-primary fw-bold">-</div>
                    <small class="text-muted">Dokumenty</small>
                  </div>
                </div>
                <div class="col-6 col-sm-3">
                  <div class="text-center">
                    <div id="clientStatsSurveys" class="h5 mb-0 text-success fw-bold">-</div>
                    <small class="text-muted">Dotazn√≠ky</small>
                  </div>
                </div>
                <div class="col-6 col-sm-3">
                  <div class="text-center">
                    <div id="clientStatsSuropen" class="h5 mb-0 text-info fw-bold">-</div>
                    <small class="text-muted">SUROPEN</small>
                  </div>
                </div>
                <div class="col-6 col-sm-3">
                  <div class="text-center">
                    <div id="clientActivity" class="badge bg-secondary">-</div>
                    <small class="text-muted d-block">Status</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigaƒçn√≠ z√°lo≈æky (skryt√© na zaƒç√°tku) -->
      <div id="tabNavigation" class="card border-0 shadow-sm mb-4" style="display: none;">
        <div class="card-body p-0">
          <nav class="nav nav-pills nav-fill">
            <button class="nav-link active rounded-0 border-0 py-3" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button">
              <i class="fas fa-chart-line me-2"></i>üìä P≈ôehled
            </button>
            <button class="nav-link rounded-0 border-0 py-3" id="cashflow-tab" data-bs-toggle="pill" data-bs-target="#cashflow" type="button">
              <i class="fas fa-money-bill-wave me-2"></i>üí∞ Cash Flow
            </button>
            <button class="nav-link rounded-0 border-0 py-3" id="surveys-tab" data-bs-toggle="pill" data-bs-target="#surveys" type="button">
              <i class="fas fa-poll me-2"></i>üìù Dotazn√≠ky
            </button>
            <button class="nav-link rounded-0 border-0 py-3" id="suropen-tab" data-bs-toggle="pill" data-bs-target="#suropen" type="button">
              <i class="fas fa-search me-2"></i>üîç SUROPEN
            </button>
            <button class="nav-link rounded-0 border-0 py-3" id="documents-tab" data-bs-toggle="pill" data-bs-target="#documents" type="button">
              <i class="fas fa-folder me-2"></i>üìÅ Dokumenty
            </button>
          </nav>
        </div>
      </div>

      <!-- Obsah z√°lo≈æek (skryt√Ω na zaƒç√°tku) -->
      <div id="tabContent" class="tab-content" style="display: none;">
        
        <!-- P≈ôehled -->
        <div class="tab-pane fade show active" id="overview">
          <!-- Prvn√≠ ≈ôada graf≈Ø -->
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient bg-primary text-white border-0">
                  <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Profit Story</h6>
                </div>
                <div class="card-body">
                  <canvas id="profitStoryChart" height="300"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient bg-success text-white border-0">
                  <h6 class="mb-0"><i class="fas fa-percentage me-2"></i>Trend ziskovosti</h6>
                </div>
                <div class="card-body">
                  <canvas id="profitabilityTrendsChart" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Druh√° ≈ôada graf≈Ø -->
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient bg-warning text-white border-0">
                  <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>R≈Øst tr≈æeb vs. COGS</h6>
                </div>
                <div class="card-body">
                  <canvas id="revCogsGrowthChart" height="300"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-gradient bg-info text-white border-0">
                  <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>R≈Øst tr≈æeb vs. provozn√≠ n√°klady</h6>
                </div>
                <div class="card-body">
                  <canvas id="revOverheadsGrowthChart" height="300"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- T≈ôet√≠ ≈ôada - velk√Ω graf -->
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="card border-0 shadow-sm">
                <div class="card-header bg-gradient bg-dark text-white border-0">
                  <h6 class="mb-0"><i class="fas fa-chart-mixed me-2"></i>Meziroƒçn√≠ p≈ôehled v≈°ech metrik</h6>
                </div>
                <div class="card-body">
                  <canvas id="allMetricsChart" height="400"></canvas>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Finanƒçn√≠ p≈ôehled -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-0">
              <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Finanƒçn√≠ p≈ôehled</h6>
            </div>
            <div class="card-body" id="financialOverview">
              <div class="text-center text-muted py-4">
                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                <p>Vyberte klienta pro zobrazen√≠ finanƒçn√≠ho p≈ôehledu</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Cash Flow -->
        <div class="tab-pane fade" id="cashflow">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient bg-success text-white border-0 d-flex justify-content-between align-items-center">
              <h6 class="mb-0"><i class="fas fa-coins me-2"></i>üí∞ Profit vs Cash Flow</h6>
              <div class="d-flex align-items-center">
                <label for="cashflow-year-select" class="form-label me-2 mb-0 text-white"><small>Rok:</small></label>
                <select id="cashflow-year-select" class="form-select form-select-sm" style="width: auto; font-size: 0.875rem;">
                  <option value="">Vyberte rok</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div id="cashflowContent">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
                  <p>Vyberte klienta pro zobrazen√≠ cash flow anal√Ωzy</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dotazn√≠ky -->
        <div class="tab-pane fade" id="surveys">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient bg-info text-white border-0">
              <h6 class="mb-0"><i class="fas fa-clipboard-question me-2"></i>Vyplnƒõn√© dotazn√≠ky</h6>
            </div>
            <div class="card-body">
              <div id="surveysContent">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-poll fa-3x mb-3"></i>
                  <p>Vyberte klienta pro zobrazen√≠ dotazn√≠k≈Ø</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SUROPEN -->
        <div class="tab-pane fade" id="suropen">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient bg-warning text-white border-0">
              <h6 class="mb-0"><i class="fas fa-magnifying-glass-chart me-2"></i>SUROPEN Anal√Ωzy</h6>
            </div>
            <div class="card-body">
              <div id="suropenContent">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-search fa-3x mb-3"></i>
                  <p>Vyberte klienta pro zobrazen√≠ SUROPEN anal√Ωz</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Dokumenty -->
        <div class="tab-pane fade" id="documents">
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient bg-secondary text-white border-0">
              <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Nahran√© dokumenty</h6>
            </div>
            <div class="card-body">
              <div id="documentsContent">
                <div class="text-center text-muted py-5">
                  <i class="fas fa-folder-open fa-3x mb-3"></i>
                  <p>Vyberte klienta pro zobrazen√≠ dokument≈Ø</p>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Pokud ≈æ√°dn√≠ klienti -->
      {% if not clients %}
        <div class="card border-0 shadow-sm">
          <div class="card-body text-center py-5">
            <i class="fas fa-users-slash fa-4x text-muted mb-4"></i>
            <h4 class="text-muted">≈Ω√°dn√≠ p≈ôi≈ôazen√≠ klienti</h4>
            <p class="text-muted">Nem√°te p≈ôi≈ôazen√© ≈æ√°dn√© klienty pro coaching.</p>
          </div>
        </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- Modern√≠ CSS styling -->
<style>
/* Modern√≠ minimalistick√© styly */
.avatar-lg {
  width: 60px;
  height: 60px;
}

.nav-pills .nav-link {
  background: transparent;
  color: #6c757d;
  font-weight: 500;
  transition: all 0.3s ease;
}

.nav-pills .nav-link:hover {
  background: rgba(13, 110, 253, 0.1);
  color: #0d6efd;
}

.nav-pills .nav-link.active {
  background: linear-gradient(135deg, #0d6efd, #6610f2);
  color: white;
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.card {
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.form-select, .form-control {
  border: 1px solid #e9ecef;
  transition: all 0.3s ease;
}

.form-select:focus, .form-control:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.bg-gradient {
  background: linear-gradient(135deg, var(--bs-primary), var(--bs-primary-dark, #0056b3));
}

.bg-gradient.bg-danger {
  background: linear-gradient(135deg, #dc3545, #b02a37);
}

.bg-gradient.bg-success {
  background: linear-gradient(135deg, #198754, #146c43);
}

.bg-gradient.bg-info {
  background: linear-gradient(135deg, #0dcaf0, #0aa2c0);
}

.bg-gradient.bg-warning {
  background: linear-gradient(135deg, #ffc107, #d39e00);
}

.bg-gradient.bg-secondary {
  background: linear-gradient(135deg, #6c757d, #565e64);
}

/* Loading spinner */
.spinner-border-sm {
  width: 1rem;
  height: 1rem;
}

/* Accordion customization */
.accordion-button:not(.collapsed) {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  color: #0d6efd;
}

.accordion-button:focus {
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Table responsiveness */
.table-responsive {
  border-radius: 0.375rem;
  overflow: hidden;
}

/* Document preview styles */
.document-item {
  transition: all 0.3s ease;
  cursor: pointer;
}

.document-item:hover {
  background: rgba(13, 110, 253, 0.05);
  border-color: #0d6efd !important;
}

/* Charts container */
canvas {
  max-height: 300px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .nav-pills .nav-link {
    font-size: 0.875rem;
    padding: 0.75rem 0.5rem;
  }
  
  .avatar-lg {
    width: 50px;
    height: 50px;
  }
}
</style>

<!-- JavaScript functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const clientSearchInput = document.getElementById('clientSearchInput');
    const searchResults = document.getElementById('searchResults');
    const dropdownIndicator = document.getElementById('dropdownIndicator');
    const clientInfoSection = document.getElementById('clientInfoSection');
    const tabNavigation = document.getElementById('tabNavigation');
    const tabContent = document.getElementById('tabContent');
    
    // Dropdown indicator click handler
    dropdownIndicator.addEventListener('click', function() {
        clientSearchInput.focus();
        if (searchResults.style.display === 'none' || !searchResults.style.display) {
            showSearchResults(allClients);
        } else {
            searchResults.style.display = 'none';
        }
    });
    
    // V≈°ichni klienti pro vyhled√°v√°n√≠
    const allClients = [
        {% for client in clients %}
        {
            id: {{ client.id }},
            company_name: "{{ client.company_name|escapejs }}",
            user_name: "{{ client.user.first_name|escapejs }} {{ client.user.last_name|escapejs }}",
            email: "{{ client.user.email|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    let selectedIndex = -1;
    
    // Focus handler - zobraz√≠ v≈°echny klienty p≈ôi focusu
    clientSearchInput.addEventListener('focus', function() {
        const query = this.value.toLowerCase().trim();
        
        if (query === '') {
            // Zobrazit v≈°echny klienty pokud je input pr√°zdn√Ω
            showSearchResults(allClients);
        } else {
            // Filtrovat podle souƒçasn√©ho textu
            const filteredClients = allClients.filter(client => 
                client.company_name.toLowerCase().includes(query) ||
                client.user_name.toLowerCase().includes(query) ||
                client.email.toLowerCase().includes(query)
            );
            showSearchResults(filteredClients);
        }
    });
    
    // Input handler - filtrov√°n√≠ p≈ôi psan√≠
    clientSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        selectedIndex = -1; // Reset v√Ωbƒõru p≈ôi psan√≠
        
        if (query === '') {
            // Zobrazit v≈°echny klienty pokud je input pr√°zdn√Ω
            showSearchResults(allClients);
            return;
        }
        
        // Filtrovat klienty podle n√°zvu firmy nebo jm√©na
        const filteredClients = allClients.filter(client => 
            client.company_name.toLowerCase().includes(query) ||
            client.user_name.toLowerCase().includes(query) ||
            client.email.toLowerCase().includes(query)
        );
        
        showSearchResults(filteredClients);
    });
    
    // Keyboard navigation
    clientSearchInput.addEventListener('keydown', function(e) {
        const results = searchResults.querySelectorAll('.client-result');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
            updateSelection(results);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection(results);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && results[selectedIndex]) {
                results[selectedIndex].click();
            }
        } else if (e.key === 'Escape') {
            searchResults.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    function updateSelection(results) {
        results.forEach((result, index) => {
            if (index === selectedIndex) {
                result.style.backgroundColor = '#007bff';
                result.style.color = 'white';
                result.scrollIntoView({ block: 'nearest' });
            } else {
                result.style.backgroundColor = '';
                result.style.color = '';
            }
        });
    }
    
    // Skr√Ωt v√Ωsledky p≈ôi kliknut√≠ mimo
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#clientSearchInput') && !e.target.closest('#searchResults')) {
            searchResults.style.display = 'none';
        }
    });
    
    function showSearchResults(clients) {
        if (clients.length === 0) {
            searchResults.innerHTML = '<div class="p-3 text-muted">Nenalezeni ≈æ√°dn√≠ klienti</div>';
        } else {
            searchResults.innerHTML = clients.map(client => `
                <div class="p-3 border-bottom client-result" style="cursor: pointer;" data-client-id="${client.id}">
                    <div class="fw-bold">${client.company_name}</div>
                    <div class="text-muted small">${client.user_name} - ${client.email}</div>
                </div>
            `).join('');
            
            // P≈ôidat event listenery pro v√Ωsledky
            searchResults.querySelectorAll('.client-result').forEach((result, index) => {
                result.addEventListener('click', function() {
                    const clientId = this.dataset.clientId;
                    const client = clients.find(c => c.id == clientId);
                    
                    // Nastavit hodnotu do inputu
                    clientSearchInput.value = `${client.company_name} - ${client.user_name}`;
                    
                    // Skr√Ωt v√Ωsledky
                    searchResults.style.display = 'none';
                    selectedIndex = -1;
                    
                    // Naƒç√≠st data klienta
                    selectClient(clientId);
                });
                
                // Hover efekt (pokud nen√≠ vybr√°n kl√°vesnic√≠)
                result.addEventListener('mouseenter', function() {
                    if (index !== selectedIndex) {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                result.addEventListener('mouseleave', function() {
                    if (index !== selectedIndex) {
                        this.style.backgroundColor = '';
                        this.style.color = '';
                    }
                });
                
                // Nastavit selected index p≈ôi hover
                result.addEventListener('mousemove', function() {
                    if (selectedIndex !== index) {
                        selectedIndex = index;
                        updateSelection(searchResults.querySelectorAll('.client-result'));
                    }
                });
            });
        }
        
        searchResults.style.display = 'block';
    }
    
    function selectClient(clientId) {
        console.log('Client selected:', clientId);
        
        if (!clientId) {
            // Hide all sections if no client selected
            clientInfoSection.style.display = 'none';
            tabNavigation.style.display = 'none';
            tabContent.style.display = 'none';
            return;
        }
        
        // Show loading state
        showLoadingState();
        
        // Load client data
        loadClientData(clientId);
    }
    
    function showLoadingState() {
        clientInfoSection.style.display = 'block';
        tabNavigation.style.display = 'block';
        tabContent.style.display = 'block';
        
        // Show loading in client info
        document.getElementById('clientCompanyName').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Naƒç√≠t√°m...';
        document.getElementById('clientContactInfo').textContent = 'Naƒç√≠t√°m informace o klientovi...';
        
        // Show loading in stats
        ['Documents', 'Surveys', 'Suropen'].forEach(stat => {
            document.getElementById('clientStats' + stat).innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        });
        document.getElementById('clientActivity').textContent = 'Naƒç√≠t√°m...';
    }
    
    function loadClientData(clientId) {
        fetch(`/coaching/client/${clientId}/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.error) {
                throw new Error(data.error);
            }
            updateClientInfo(data);
            updateTabContents(data);
        })
        .catch(error => {
            console.error('Error loading client data:', error);
            showErrorState(error.message);
        });
    }
    
    function updateClientInfo(data) {
        // Update client basic info
        document.getElementById('clientCompanyName').textContent = data.client.company_name;
        document.getElementById('clientContactInfo').innerHTML = 
            `<i class="fas fa-user me-1"></i>${data.client.user.first_name} ${data.client.user.last_name}<br>
             <i class="fas fa-envelope me-1"></i>${data.client.user.email}`;
        
        // Update stats
        document.getElementById('clientStatsDocuments').textContent = data.statements_count + data.documents_count;
        document.getElementById('clientStatsSurveys').textContent = data.surveys_completed;
        document.getElementById('clientStatsSuropen').textContent = data.suropen_answers.length;
        
        // Update activity status
        const activityBadge = document.getElementById('clientActivity');
        if (data.days_since_activity <= 7) {
            activityBadge.className = 'badge bg-success';
            activityBadge.textContent = 'Aktivn√≠';
        } else if (data.days_since_activity <= 30) {
            activityBadge.className = 'badge bg-warning';
            activityBadge.textContent = 'M√©nƒõ aktivn√≠';
        } else {
            activityBadge.className = 'badge bg-danger';
            activityBadge.textContent = 'Neaktivn√≠';
        }
    }
    
    function updateTabContents(data) {
        updateOverviewTab(data);
        updateCashflowTab(data);
        updateSurveysTab(data);
        updateSuropenTab(data);
        updateDocumentsTab(data);
    }
    
    function updateOverviewTab(data) {
        // Update charts if data available
        if (data.chart_data && data.chart_data.length > 0) {
            createCharts(data);
        }
        
        // Update financial overview s daty z nejnovƒõj≈°√≠ho roku
        const overview = document.getElementById('financialOverview');
        if (data.chart_data && data.chart_data.length > 0) {
            const latestYear = data.chart_data[data.chart_data.length - 1];
            overview.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-3 text-center">
                        <div class="p-3 bg-primary bg-gradient rounded text-white">
                            <h4 class="mb-1">${Number(latestYear.revenue).toLocaleString()} Kƒç</h4>
                            <small>Tr≈æby ${latestYear.year}</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="p-3 bg-success bg-gradient rounded text-white">
                            <h4 class="mb-1">${Number(latestYear.gross_margin).toLocaleString()} Kƒç</h4>
                            <small>Hrub√° mar≈æe</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="p-3 bg-info bg-gradient rounded text-white">
                            <h4 class="mb-1">${Number(latestYear.ebit).toLocaleString()} Kƒç</h4>
                            <small>EBIT</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="p-3 ${latestYear.net_profit >= 0 ? 'bg-success' : 'bg-danger'} bg-gradient rounded text-white">
                            <h4 class="mb-1">${Number(latestYear.net_profit).toLocaleString()} Kƒç</h4>
                            <small>ƒåist√Ω zisk</small>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mt-3">
                    <div class="col-md-4 text-center">
                        <div class="p-2 bg-light rounded">
                            <h6 class="mb-1">${latestYear.profitability.gm_pct.toFixed(1)}%</h6>
                            <small class="text-muted">Hrub√° mar≈æe</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-2 bg-light rounded">
                            <h6 class="mb-1">${latestYear.profitability.op_pct.toFixed(1)}%</h6>
                            <small class="text-muted">Provozn√≠ mar≈æe</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-2 bg-light rounded">
                            <h6 class="mb-1">${latestYear.profitability.np_pct.toFixed(1)}%</h6>
                            <small class="text-muted">ƒåist√° mar≈æe</small>
                        </div>
                    </div>
                </div>
            `;
        } else {
            overview.innerHTML = `
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Klient zat√≠m nenahr√°l finanƒçn√≠ data pro zobrazen√≠ p≈ôehledu.
                </div>
            `;
        }
    }
    
    function updateCashflowTab(data) {
        const content = document.getElementById('cashflowContent');
        const yearSelect = document.getElementById('cashflow-year-select');
        
        // Aktualizuj v√Ωbƒõr rok≈Ø
        if (data.cashflow && data.cashflow.available_years) {
            yearSelect.innerHTML = '<option value="">Vyberte rok</option>';
            data.cashflow.available_years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === data.cashflow.current_year) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            });
        }
        
        if (data.has_cashflow_data && data.cashflow) {
            // TABULKA PROFIT VS CASH FLOW (stejn√° jako m√° klient)
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>Polo≈æka</th>
                                <th>Profit</th>
                                <th>Cash Flow</th>
                                <th>Rozd√≠l</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Tr≈æby</strong></td>
                                <td>${Number(data.cashflow.revenue || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td>${Number(data.cashflow.gross_cash_profit || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td class="${(data.cashflow.variance.gross || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${Number(data.cashflow.variance.gross || 0).toLocaleString('cs-CZ')} Kƒç
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Provozn√≠ zisk</strong></td>
                                <td>${Number(data.cashflow.operating_cash_profit || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td>${Number(data.cashflow.operating_cash_flow || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td class="${(data.cashflow.variance.operating || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${Number(data.cashflow.variance.operating || 0).toLocaleString('cs-CZ')} Kƒç
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ƒåist√Ω zisk</strong></td>
                                <td>${Number(data.cashflow.retained_profit || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td>${Number(data.cashflow.net_cash_flow || 0).toLocaleString('cs-CZ')} Kƒç</td>
                                <td class="${(data.cashflow.variance.net || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                    ${Number(data.cashflow.variance.net || 0).toLocaleString('cs-CZ')} Kƒç
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <p class="text-muted small mt-3 mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Anal√Ωza porovn√°v√° √∫ƒçetn√≠ v√Ωsledky s re√°ln√Ωm cash flow za rok ${data.cashflow.current_year || 'N/A'}.
                    Rozd√≠ly ukazuj√≠, kde se pen√≠ze "ztr√°cej√≠" nebo "objevuj√≠" vzhledem k zisku.
                </p>
            `;
            
            content.innerHTML = tableHtml;
        } else {
            content.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">≈Ω√°dn√° cash flow data</h5>
                    <p class="text-muted">Klient zat√≠m nenahr√°l finanƒçn√≠ data.</p>
                </div>
            `;
        }
    }
    
    function updateSurveysTab(data) {
        const content = document.getElementById('surveysContent');
        
        if (data.survey_details && data.survey_details.length > 0) {
            let accordionHtml = '<div class="accordion" id="surveysAccordion">';
            
            data.survey_details.forEach((survey, index) => {
                const collapseId = `survey-${index}`;
                accordionHtml += `
                    <div class="accordion-item border-0 shadow-sm mb-3">
                        <h6 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-poll me-3"></i>
                                    <div>
                                        <div class="fw-bold">Dotazn√≠k z ${new Date(survey.submission.created_at).toLocaleDateString('cs-CZ')}</div>
                                        <small class="text-muted">${survey.response_count} odpovƒõd√≠ ‚Ä¢ Pr≈Ømƒõrn√© hodnocen√≠: ${Math.round(survey.avg_score * 10) / 10}/10</small>
                                    </div>
                                </div>
                            </button>
                        </h6>
                        <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#surveysAccordion">
                            <div class="accordion-body">
                `;
                
                // Zobrazen√≠ ot√°zek a odpovƒõd√≠
                survey.responses.forEach(response => {
                    accordionHtml += `
                        <div class="mb-4 pb-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-1 text-primary">${response.question}</h6>
                                ${response.score ? `<span class="badge bg-primary">${response.score}/10</span>` : ''}
                            </div>
                            <p class="text-muted mb-0">${response.answer_text || 'Bez odpovƒõdi'}</p>
                        </div>
                    `;
                });
                
                // P≈ôid√°n√≠ AI shrnut√≠ (pokud existuje)
                if (survey.submission.ai_response) {
                    accordionHtml += `
                        <div class="alert alert-light border-start border-5 border-primary">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-robot text-primary me-2"></i>
                                <h6 class="mb-0 text-primary">AI Shrnut√≠ a doporuƒçen√≠</h6>
                            </div>
                            <div class="text-muted" style="white-space: pre-line;">${survey.submission.ai_response}</div>
                        </div>
                    `;
                }
                
                accordionHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            accordionHtml += '</div>';
            content.innerHTML = accordionHtml;
        } else {
            content.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-clipboard-question fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">≈Ω√°dn√© vyplnƒõn√© dotazn√≠ky</h5>
                    <p class="text-muted">Klient zat√≠m nevyplnil ≈æ√°dn√© dotazn√≠ky.</p>
                </div>
            `;
        }
    }
    
    function updateSuropenTab(data) {
        const content = document.getElementById('suropenContent');
        
        if (data.suropen_answers && data.suropen_answers.length > 0) {
            let accordionHtml = '<div class="accordion" id="suropenAccordion">';
            
            data.suropen_answers.forEach((batch, index) => {
                const collapseId = `suropen-${index}`;
                accordionHtml += `
                    <div class="accordion-item border-0 shadow-sm mb-3">
                        <h6 class="accordion-header">
                            <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-magnifying-glass-chart me-3"></i>
                                    <div>
                                        <div class="fw-bold">SUROPEN anal√Ωza z ${new Date(batch.created_at).toLocaleDateString('cs-CZ')}</div>
                                        <small class="text-muted">${batch.answers.length} odpovƒõd√≠</small>
                                    </div>
                                </div>
                            </button>
                        </h6>
                        <div id="${collapseId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" 
                             data-bs-parent="#suropenAccordion">
                            <div class="accordion-body">
                                <h6 class="text-primary mb-3">Odpovƒõdi klienta:</h6>
                `;
                
                batch.answers.forEach(answer => {
                    accordionHtml += `
                        <div class="mb-3 p-3 bg-light rounded">
                            <div class="fw-medium text-dark mb-1">${answer.question}</div>
                            <div class="text-muted">${answer.answer}</div>
                        </div>
                    `;
                });
                
                if (batch.ai_response) {
                    accordionHtml += `
                        <hr class="my-4">
                        <h6 class="text-warning mb-3"><i class="fas fa-robot me-2"></i>AI Anal√Ωza:</h6>
                        <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning">
                            ${batch.ai_response}
                        </div>
                    `;
                }
                
                accordionHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            accordionHtml += '</div>';
            content.innerHTML = accordionHtml;
        } else {
            content.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">≈Ω√°dn√© SUROPEN anal√Ωzy</h5>
                    <p class="text-muted">Klient zat√≠m neprovedl ≈æ√°dnou SUROPEN anal√Ωzu.</p>
                </div>
            `;
        }
    }
    
    function updateDocumentsTab(data) {
        const content = document.getElementById('documentsContent');
        
        let documentsHtml = '';
        
        // Finanƒçn√≠ v√Ωkazy
        if (data.financial_statements && data.financial_statements.length > 0) {
            documentsHtml += `
                <div class="mb-4">
                    <h6 class="text-primary mb-3"><i class="fas fa-chart-bar me-2"></i>Finanƒçn√≠ v√Ωkazy (${data.financial_statements.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-file me-1"></i>Dokument</th>
                                    <th>Typ</th>
                                    <th>Datum nahr√°n√≠</th>
                                    <th>Popis</th>
                                    <th class="text-center">Akce</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.financial_statements.forEach(doc => {
                documentsHtml += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                <span class="fw-medium">${doc.filename}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-primary">${doc.get_doc_type_display || doc.doc_type}</span></td>
                        <td><small class="text-muted">${new Date(doc.uploaded_at).toLocaleDateString('cs-CZ')}</small></td>
                        <td><small class="text-muted">${doc.description || 'Bez popisu'}</small></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocument('${doc.id}', '${doc.file_url}')">
                                <i class="fas fa-eye me-1"></i>Zobrazit
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            documentsHtml += '</tbody></table></div></div>';
        }
        
        // Ostatn√≠ dokumenty
        if (data.other_documents && data.other_documents.length > 0) {
            documentsHtml += `
                <div class="mb-4">
                    <h6 class="text-secondary mb-3"><i class="fas fa-folder me-2"></i>Ostatn√≠ dokumenty (${data.other_documents.length})</h6>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th><i class="fas fa-file me-1"></i>Dokument</th>
                                    <th>Typ</th>
                                    <th>Datum nahr√°n√≠</th>
                                    <th>Popis</th>
                                    <th class="text-center">Akce</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            data.other_documents.forEach(doc => {
                documentsHtml += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-secondary me-2"></i>
                                <span class="fw-medium">${doc.filename}</span>
                            </div>
                        </td>
                        <td><span class="badge bg-secondary">${doc.get_doc_type_display || doc.doc_type || 'Dokument'}</span></td>
                        <td><small class="text-muted">${new Date(doc.uploaded_at).toLocaleDateString('cs-CZ')}</small></td>
                        <td><small class="text-muted">${doc.description || 'Bez popisu'}</small></td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewDocument('${doc.id}', '${doc.file_url}')">
                                <i class="fas fa-eye me-1"></i>Zobrazit
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            documentsHtml += '</tbody></table></div></div>';
        }
        
        if (!documentsHtml) {
            documentsHtml = `
                <div class="text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">≈Ω√°dn√© dokumenty</h5>
                    <p class="text-muted">Klient zat√≠m nenahr√°l ≈æ√°dn√© dokumenty.</p>
                </div>
            `;
        }
        
        content.innerHTML = documentsHtml;
    }
    
    function createCharts(data) {
        if (!data.chart_data || data.chart_data.length === 0) {
            console.log('No chart data available');
            return;
        }
        
        const dataRows = data.chart_data;
        const labels = dataRows.map(r => r.year);
        
        // 1. PROFIT STORY CHART (stejn√Ω jako m√° klient)
        const profitStoryCtx = document.getElementById('profitStoryChart').getContext('2d');
        const categories = ["Tr≈æby", "COGS", "Hrub√° mar≈æe", "Provozn√≠ n√°klady", "EBIT", "ƒåist√Ω zisk"];
        const datasets = dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
            backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
        }));
        
        new Chart(profitStoryCtx, {
            type: "bar",
            data: { labels: categories, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: "V√°≈° p≈ô√≠bƒõh zisku (Profit Story)",
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: {
                        callbacks: {
                            label: (item) => `${item.dataset.label}: ${item.formattedValue.toLocaleString('cs-CZ')} Kƒç`
                        }
                    },
                    legend: { position: "top" }
                },
                scales: {
                    y: {
                        title: { display: true, text: "Hodnota (Kƒç)" },
                        ticks: { callback: (v) => v.toLocaleString('cs-CZ') }
                    }
                }
            }
        });

        // 2. PROFITABILITY TRENDS CHART (Trend ziskovosti)
        const profitabilityTrendsCtx = document.getElementById('profitabilityTrendsChart').getContext('2d');
        const datasetsTrends = dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
            backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
        }));
        
        new Chart(profitabilityTrendsCtx, {
            type: "bar",
            data: { labels: ["Hrub√° mar≈æe %", "Provozn√≠ mar≈æe %", "ƒåist√° mar≈æe %"], datasets: datasetsTrends },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: "Trend ziskovosti",
                        font: { size: 16, weight: 'bold' }
                    },
                    tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
                },
                scales: { y: { ticks: { callback: (v) => v + "%" } } }
            }
        });

        // 3. REVENUE VS COGS GROWTH CHART (R≈Øst tr≈æeb vs. COGS)
        const revCogsGrowthCtx = document.getElementById('revCogsGrowthChart').getContext('2d');
        const revGrowth = dataRows.map(row => row.growth.revenue);
        const cogsGrowth = dataRows.map(row => row.growth.cogs);
        
        new Chart(revCogsGrowthCtx, {
            type: "bar",
            data: {
                labels: dataRows.map(row => row.year),
                datasets: [
                    { label: "R≈Øst tr≈æeb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
                    { label: "R≈Øst n√°klad≈Ø na prodan√© zbo≈æ√≠ (%)", data: cogsGrowth, backgroundColor: "rgba(255,99,132,0.7)" }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: true, 
                        text: "R≈Øst tr≈æeb vs. r≈Øst n√°klad≈Ø na prodan√© zbo≈æ√≠", 
                        font: { size: 16, weight: 'bold' } 
                    },
                    tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
                },
                scales: { y: { ticks: { callback: (v) => v + "%" } } }
            }
        });

        // 4. REVENUE VS OVERHEADS GROWTH CHART (R≈Øst tr≈æeb vs. provozn√≠ n√°klady)
        const revOverheadsGrowthCtx = document.getElementById('revOverheadsGrowthChart').getContext('2d');
        const overheadsGrowth = dataRows.map(row => row.growth.overheads);
        
        new Chart(revOverheadsGrowthCtx, {
            type: "bar",
            data: {
                labels: dataRows.map(row => row.year),
                datasets: [
                    { label: "R≈Øst tr≈æeb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
                    { label: "R≈Øst provozn√≠ch n√°klad≈Ø (%)", data: overheadsGrowth, backgroundColor: "rgba(255,206,86,0.7)" }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: true, 
                        text: "R≈Øst tr≈æeb vs. r≈Øst provozn√≠ch n√°klad≈Ø", 
                        font: { size: 16, weight: 'bold' } 
                    },
                    tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
                },
                scales: { y: { ticks: { callback: (v) => v + "%" } } }
            }
        });

        // 5. ALL METRICS CHART (Meziroƒçn√≠ p≈ôehled v≈°ech metrik)
        const allMetricsCtx = document.getElementById('allMetricsChart').getContext('2d');
        
        new Chart(allMetricsCtx, {
            type: "line",
            data: {
                labels: dataRows.map(row => row.year),
                datasets: [
                    { label: "Tr≈æby", data: dataRows.map(r => r.revenue), borderColor: "blue", tension: 0.3, fill: false },
                    { label: "COGS (n√°klady na prodan√© zbo≈æ√≠)", data: dataRows.map(r => r.cogs), borderColor: "red", tension: 0.3, fill: false },
                    { label: "Hrub√° mar≈æe", data: dataRows.map(r => r.gross_margin), borderColor: "green", tension: 0.3, fill: false },
                    { label: "Provozn√≠ n√°klady", data: dataRows.map(r => r.overheads), borderColor: "orange", tension: 0.3, fill: false },
                    { label: "EBIT", data: dataRows.map(r => r.ebit), borderColor: "purple", tension: 0.3, fill: false },
                    { label: "ƒåist√Ω zisk", data: dataRows.map(r => r.net_profit), borderColor: "brown", tension: 0.3, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { 
                        display: true, 
                        text: "Meziroƒçn√≠ v√Ωvoj hlavn√≠ch metrik", 
                        font: { size: 16, weight: 'bold' } 
                    },
                    tooltip: { 
                        callbacks: { 
                            label: (item) => `${item.dataset.label}: ${item.formattedValue.toLocaleString('cs-CZ')} Kƒç` 
                        } 
                    },
                    legend: { position: "top" }
                },
                scales: {
                    y: { 
                        ticks: { 
                            callback: (v) => v.toLocaleString('cs-CZ') + " Kƒç" 
                        } 
                    }
                }
            }
        });
    }
    
    function showErrorState(errorMessage) {
        document.getElementById('clientCompanyName').textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠';
        document.getElementById('clientContactInfo').innerHTML = 
            `<i class="fas fa-exclamation-triangle text-danger me-1"></i>${errorMessage || 'Nepoda≈ôilo se naƒç√≠st informace o klientovi'}`;
        
        // Reset stats to error state
        ['Documents', 'Surveys', 'Suropen'].forEach(stat => {
            document.getElementById('clientStats' + stat).innerHTML = '<i class="fas fa-times text-danger"></i>';
        });
        document.getElementById('clientActivity').className = 'badge bg-danger';
        document.getElementById('clientActivity').textContent = 'Chyba';
    }
    
    // Document viewer function - otev≈ôe PDF v nov√©m oknƒõ
    window.viewDocument = function(documentId, documentUrl) {
        // Pokud URL nen√≠ p≈ôedan√°, vytvo≈ô√≠me fallback URL
        if (!documentUrl) {
            console.warn('Document URL not provided, using fallback');
            documentUrl = `/media/documents/${documentId}/`;
        }
        
        // Pokus√≠me se otev≈ô√≠t v nov√©m oknƒõ
        try {
            const newWindow = window.open(documentUrl, '_blank', 'width=1000,height=800,scrollbars=yes,resizable=yes');
            if (!newWindow) {
                // Pokud se nepoda≈ôilo otev≈ô√≠t v nov√©m oknƒõ (blokov√°no popup), zkus√≠me p≈ô√≠m√Ω odkaz
                window.location.href = documentUrl;
            }
        } catch (error) {
            console.error('Error opening document:', error);
            // Fallback - st√°hne soubor
            const link = document.createElement('a');
            link.href = documentUrl;
            link.download = '';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };
});
</script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}