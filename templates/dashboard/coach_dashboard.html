{% extends "base.html" %}
{% block content %}
<div class="section-shell">
  <section class="scb-panel scb-panel--inline">
    <div class="page-heading">
      <span class="page-eyebrow">Coaching</span>
      <h2 class="page-title">ğŸ¤ Dashboard kouÄe</h2>
      <p class="page-subtitle">
        PÅ™epÃ­nejte mezi klienty, sledujte jejich poslednÃ­ vÃ½kazy a pÅ™ipravte si cÃ­lenÃ© doporuÄenÃ­ bÄ›hem chvilky.
      </p>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-3">
      <span class="scb-metric-bubble">ğŸ‘¤ {{ request.user.username }}</span>
      <form method="get" class="d-flex flex-wrap align-items-center gap-2">
        <label class="filter-title mb-0" for="client">Vyber klienta</label>
        <select name="client" id="client" class="form-select scb-select-inline" onchange="this.form.submit()">
          <option value="">-- Vyber --</option>
          {% for c in clients %}
          <option value="{{ c.id }}" {% if selected_client and selected_client.id == c.id %}selected{% endif %}>
            {{ c.username }} ({{ c.companyprofile.company_name }})
          </option>
          {% endfor %}
        </select>
      </form>
    </div>
  </section>

  {% if selected_client %}
  <section class="scb-panel">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h3 class="m-0">ğŸ’¬ Intercom s klientem</h3>
        <small class="text-muted">RychlÃ¡ komunikace s {{ selected_client.username }}</small>
      </div>
      <a href="{% url 'intercom:thread' client_id=selected_client.id %}" class="scb-btn scb-btn-ghost">OtevÅ™Ã­t celÃ© vlÃ¡kno</a>
    </div>

    <div id="coach-intercom-{{ selected_client.id }}" class="mt-3 border rounded-4 p-3" 
         hx-get="{% url 'intercom:thread' client_id=selected_client.id %}"
         hx-trigger="load"
         hx-select="#messages > *"
         hx-target="#coach-intercom-{{ selected_client.id }}"
         hx-swap="innerHTML">
      <div class="text-muted">NaÄÃ­tÃ¡m konverzaciâ€¦</div>
    </div>

    <!-- auto-mark notifications as read when tile loads -->
    <form hx-post="{% url 'intercom:mark_read' %}" hx-trigger="load" hx-swap="none">
      {% csrf_token %}
    </form>

    <form class="mt-3 d-flex gap-2"
          hx-post="{% url 'intercom:send' client_id=selected_client.id %}"
          hx-target="#coach-intercom-{{ selected_client.id }}"
          hx-swap="beforeend">
      {% csrf_token %}
      <input type="text" name="body" placeholder="RychlÃ¡ odpovÄ›Äâ€¦" class="form-control"/>
      <button class="scb-btn scb-btn-primary" type="submit">Odeslat</button>
    </form>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  </section>
  {% endif %}

  <section class="scb-panel">
    {% if selected_client %}
    <div class="scb-panel-header">
      <h3>ğŸ“„ Data pro: {{ company.company_name }}</h3>
      <p class="panel-subtitle">Souhrn poslednÃ­ch importovanÃ½ch vÃ½kazÅ¯ klienta.</p>
    </div>
    <ul class="scb-list mt-3">
      {% for s in statements %}
      <li class="scb-list-item">
        <div>
          <strong>{{ s.year }}</strong>
          <span class="d-block">{{ s.document.doc_type }}</span>
        </div>
        <span class="scb-code">{{ s.data|truncatechars:60 }}</span>
      </li>
      {% empty %}
      <li class="scb-list-item">
        <div>
          <strong>Å½Ã¡dnÃ¡ data</strong>
          <span class="d-block">PoÅ¾Ã¡dejte klienta o nahrÃ¡nÃ­ finanÄnÃ­ch dokumentÅ¯.</span>
        </div>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <p class="panel-subtitle mb-0">Vyberte klienta pro zobrazenÃ­ dat.</p>
    {% endif %}
  </section>
</div>
{% endblock %}
