{% extends "base.html" %}

{% block extra_head %}
  <script>
    tailwind.config = {
      corePlugins: {
        preflight: false,
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
{% endblock %}

{% block extra_scripts %}
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    const rows = JSON.parse('{{ rows|escapejs }}');
    const years = JSON.parse('{{ years|escapejs }}');
    const chartSeries = JSON.parse('{{ chart_series|escapejs }}');
    const scoreHistoryData = JSON.parse('{{ score_history|default:"[]"|escapejs }}');

    let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

    function getSelectedYears() {
      const selected = Array.from(document.querySelectorAll('.year-filter:checked')).map((cb) => parseInt(cb.value, 10));
      if (!selected.length) {
        return years.slice();
      }
      return selected;
    }

    function filterRowsByYears(selectedYears) {
      return rows.filter((row) => selectedYears.includes(row.year));
    }

    function destroyIfExists(chart) {
      if (chart && typeof chart.destroy === 'function') {
        chart.destroy();
      }
    }

    function renderCharts() {
      const selectedYears = getSelectedYears();
      const dataRows = filterRowsByYears(selectedYears);
      const labels = dataRows.map((row) => row.year);

      // Profit Story
      destroyIfExists(profitStoryChart);
      profitStoryChart = new Chart(document.getElementById('profitStoryChart'), {
        type: 'bar',
        data: {
          labels: ['TrÅ¾by', 'NÃ¡klady na prodanÃ© zboÅ¾Ã­', 'HrubÃ¡ marÅ¾e', 'ProvoznÃ­ nÃ¡klady', 'EBIT', 'ÄŒistÃ½ zisk'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
            backgroundColor: `hsl(${(idx * 70) % 360}, 70%, 54%)`,
            borderRadius: 12,
            maxBarThickness: 40,
          })),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                label: (item) => `${item.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} KÄ`,
              },
            },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: {
              ticks: {
                callback: (value) => Number(value).toLocaleString('cs-CZ'),
              },
            },
          },
        },
      });
      window.profitStoryChart = profitStoryChart;

      // Profitability Trends
      destroyIfExists(profitabilityTrendsChart);
      profitabilityTrendsChart = new Chart(document.getElementById('profitabilityTrendsChart'), {
        type: 'bar',
        data: {
          labels: ['HrubÃ¡ marÅ¾e %', 'ProvoznÃ­ marÅ¾e %', 'ÄŒistÃ¡ marÅ¾e %'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
            backgroundColor: `hsl(${(idx * 70) % 360}, 70%, 54%)`,
            borderRadius: 12,
            maxBarThickness: 40,
          })),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: { ticks: { callback: (value) => `${value}%` } },
          },
        },
      });
      window.profitabilityTrendsChart = profitabilityTrendsChart;

      // Revenue vs COGS growth
      const revGrowth = dataRows.map((row) => row.growth.revenue);
      const cogsGrowth = dataRows.map((row) => row.growth.cogs);
      destroyIfExists(revCogsGrowthChart);
      revCogsGrowthChart = new Chart(document.getElementById('revCogsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'RÅ¯st trÅ¾eb (%)', data: revGrowth, backgroundColor: 'rgba(59,130,246,0.75)', borderRadius: 10, maxBarThickness: 42 },
            { label: 'RÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­ (%)', data: cogsGrowth, backgroundColor: 'rgba(248,113,113,0.75)', borderRadius: 10, maxBarThickness: 42 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: { y: { ticks: { callback: (value) => `${value}%` } } },
        },
      });
      window.revCogsGrowthChart = revCogsGrowthChart;

      // Revenue vs overheads growth
      const overheadGrowth = dataRows.map((row) => row.growth.overheads);
      destroyIfExists(revOverheadsGrowthChart);
      revOverheadsGrowthChart = new Chart(document.getElementById('revOverheadsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'RÅ¯st trÅ¾eb (%)', data: revGrowth, backgroundColor: 'rgba(14,116,144,0.75)', borderRadius: 10, maxBarThickness: 42 },
            { label: 'RÅ¯st provoznÃ­ch nÃ¡kladÅ¯ (%)', data: overheadGrowth, backgroundColor: 'rgba(250,204,21,0.75)', borderRadius: 10, maxBarThickness: 42 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: { y: { ticks: { callback: (value) => `${value}%` } } },
        },
      });
      window.revOverheadsGrowthChart = revOverheadsGrowthChart;

      // All metrics chart
      destroyIfExists(allMetricsChart);
      allMetricsChart = new Chart(document.getElementById('allMetricsChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'TrÅ¾by', data: dataRows.map((r) => r.revenue), borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'COGS', data: dataRows.map((r) => r.cogs), borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'HrubÃ¡ marÅ¾e', data: dataRows.map((r) => r.gross_margin), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'ProvoznÃ­ nÃ¡klady', data: dataRows.map((r) => r.overheads), borderColor: '#facc15', backgroundColor: 'rgba(250,204,21,0.18)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'EBIT', data: dataRows.map((r) => r.ebit), borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'ÄŒistÃ½ zisk', data: dataRows.map((r) => r.net_profit), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} KÄ` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: {
              ticks: {
                callback: (value) => Number(value).toLocaleString('cs-CZ') + ' KÄ',
              },
            },
          },
        },
      });
      window.allMetricsChart = allMetricsChart;
    }

    function renderSparkline() {
      const spark = document.getElementById('scoreSparkline');
      if (!spark || !scoreHistoryData.length) return;
      const sparkChart = new Chart(spark, {
        type: 'line',
        data: {
          labels: scoreHistoryData.map((item) => item.label),
          datasets: [{
            data: scoreHistoryData.map((item) => item.value),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99,102,241,0.18)',
            tension: 0.4,
            borderWidth: 2,
            fill: true,
            pointRadius: 2,
          }],
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: false,
        },
      });
      window.scoreSparklineChart = sparkChart;
    }

    function renderMetricTrendChart() {
      const ctx = document.getElementById('metricsTrendChart');
      if (!ctx || !chartSeries.labels || !chartSeries.labels.length) return;
      window.metricsTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartSeries.labels,
          datasets: [
            {
              label: 'TrÅ¾by',
              data: chartSeries.revenue,
              borderColor: '#0a58f5',
              backgroundColor: 'rgba(10, 88, 245, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: 'ÄŒistÃ½ zisk',
              data: chartSeries.net_profit,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: 'EBIT',
              data: chartSeries.ebit,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249, 115, 22, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${Number(context.parsed.y || 0).toLocaleString('cs-CZ')} KÄ`,
              },
            },
          },
          scales: {
            y: { ticks: { callback: (value) => Number(value).toLocaleString('cs-CZ') + ' KÄ' } },
          },
        },
      });
    }

    function getCookie(name) {
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < cookies.length; i += 1) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === `${name}=`) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }

    async function saveChartAsImage(chart, chartId) {
      if (!chart || typeof chart.toBase64Image !== 'function') {
        return;
      }
      const dataUrl = chart.toBase64Image('image/png', 1);
      if (!dataUrl || dataUrl.length < 100) {
        return;
      }
      try {
        const response = await fetch('{% url "dashboard:save_chart" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ image: dataUrl, chart_id: chartId }),
        });
        const payload = await response.json();
        if (payload.status !== 'ok') {
          console.warn('NepodaÅ™ilo se uloÅ¾it graf:', chartId, payload);
        }
      } catch (error) {
        console.error('Chyba pÅ™i uklÃ¡dÃ¡nÃ­ grafu', chartId, error);
      }
      await new Promise((resolve) => setTimeout(resolve, 150));
    }

    async function saveAllCharts() {
      const charts = [
        { chart: window.profitStoryChart, id: 'profit_story' },
        { chart: window.profitabilityTrendsChart, id: 'profitability_trends' },
        { chart: window.revCogsGrowthChart, id: 'rev_cogs_growth' },
        { chart: window.revOverheadsGrowthChart, id: 'rev_overheads_growth' },
        { chart: window.allMetricsChart, id: 'all_metrics' },
        { chart: window.metricsTrendChart, id: 'metrics_trend' },
      ];
      for (const cfg of charts) {
        await saveChartAsImage(cfg.chart, cfg.id);
      }
    }

    async function loadCashflowForYear(year) {
      const container = document.getElementById('cashflow-content');
      if (!container || !year) {
        return;
      }
      container.innerHTML = '<div class="py-8 text-center text-sm text-slate-500 bg-white/90">NaÄÃ­tÃ¡me penÄ›Å¾nÃ­ tokâ€¦</div>';
      try {
        const response = await fetch(`/dashboard/api/cashflow/${year}/`);
        if (!response.ok) {
          throw new Error('response not ok');
        }
        const html = await response.text();
        container.innerHTML = html;
        if (window.bootstrap) {
          const tooltips = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltips.map((el) => new bootstrap.Tooltip(el));
        }
      } catch (error) {
        console.error('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ cashflow', error);
        container.innerHTML = '<div class="py-8 text-sm text-rose-600 text-center bg-white/90">NepodaÅ™ilo se naÄÃ­st cashflow data. Zkus to prosÃ­m znovu.</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCharts();
      renderSparkline();
      renderMetricTrendChart();

      document.querySelectorAll('.year-filter').forEach((cb) => {
        cb.addEventListener('change', renderCharts);
      });

      if (window.bootstrap) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
      }

      const contactForm = document.getElementById('coachContactForm');
      if (contactForm) {
        const messageInput = document.getElementById('coachMessage');
        const statusEl = document.getElementById('coachContactStatus');
        const setContactStatus = (text, tone = 'info') => {
          statusEl.textContent = text;
          statusEl.classList.remove('text-slate-500', 'text-emerald-600', 'text-rose-600', 'text-amber-600');
          if (tone === 'success') {
            statusEl.classList.add('text-emerald-600');
          } else if (tone === 'error') {
            statusEl.classList.add('text-rose-600');
          } else if (tone === 'warning') {
            statusEl.classList.add('text-amber-600');
          } else {
            statusEl.classList.add('text-slate-500');
          }
        };
        contactForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const message = (messageInput?.value || '').trim();
          if (!message) {
            setContactStatus('NapiÅ¡ struÄnÄ›, s ÄÃ­m potÅ™ebujeÅ¡ pomoct.', 'warning');
            return;
          }
          setContactStatus('PosÃ­lÃ¡m dotaz kouÄoviâ€¦', 'info');
          try {
            const response = await fetch('{% url "dashboard:ask_coach" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
              },
              body: JSON.stringify({ message }),
            });
            const data = await response.json();
            if (!data.success) {
              throw new Error(data.error || 'Chyba pÅ™i odeslÃ¡nÃ­');
            }
            setContactStatus(data.reply || 'ZprÃ¡va byla odeslÃ¡na.', 'success');
            messageInput.value = '';
          } catch (error) {
            setContactStatus('NepodaÅ™ilo se odeslat dotaz. Zkus to prosÃ­m znovu.', 'error');
            console.error(error);
          }
        });
      }

      const exportBtn = document.getElementById('chart-export-trigger');
      const exportStatus = document.getElementById('chart-export-status');
      const setStatus = (text, tone = 'info') => {
        if (exportStatus) {
          exportStatus.textContent = text;
          exportStatus.dataset.statusTone = tone;
        }
      };

      if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
          if (exportBtn.dataset.busy === '1') {
            return;
          }
          exportBtn.dataset.busy = '1';
          exportBtn.classList.add('is-busy');
          exportBtn.setAttribute('aria-disabled', 'true');
          const originalLabel = exportBtn.innerHTML;
          exportBtn.innerHTML = 'â³ PÅ™ipravuji grafyâ€¦';
          setStatus('Grafy uklÃ¡dÃ¡me. Po dokonÄenÃ­ otevÅ™eme export.', 'info');
          await saveAllCharts();
          exportBtn.innerHTML = 'âœ… Grafy pÅ™ipraveny';
          setStatus('Grafy jsou uloÅ¾enÃ©, pokraÄuj na export PDF.', 'success');
          setTimeout(() => {
            exportBtn.dataset.busy = '0';
            exportBtn.classList.remove('is-busy');
            exportBtn.removeAttribute('aria-disabled');
            exportBtn.innerHTML = originalLabel;
            window.location.href = '{% url "exports:export_form" %}';
          }, 900);
        });
      }

      const cashflowSelect = document.getElementById('cashflow-year-select');
      if (cashflowSelect) {
        cashflowSelect.addEventListener('change', (event) => loadCashflowForYear(event.target.value));
        if (cashflowSelect.value) {
          loadCashflowForYear(cashflowSelect.value);
        }
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 py-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <header class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">Dashboard</p>
        <h1 class="text-3xl font-bold text-slate-900">FinanÄnÃ­ cockpit</h1>
        <p class="text-sm text-slate-500 mt-2">Souhrn zdravÃ­ firmy, doporuÄenÃ­ a nÃ¡stroje pro rychlÃ½ kontakt s kouÄem.</p>
      </div>
      {% if assigned_coach %}
      <div class="bg-white/85 border border-slate-200/70 rounded-2xl px-4 py-3 shadow-sm">
        <p class="text-xs uppercase tracking-wide text-slate-400">TvÅ¯j kouÄ</p>
        <p class="text-sm font-semibold text-slate-800">{{ assigned_coach.user.get_full_name|default:assigned_coach }}</p>
        <p class="text-xs text-slate-500">PÅ™ipraven reagovat na dotazy</p>
      </div>
      {% endif %}
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-6 gap-6">
      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">SkÃ³re firmy</p>
            <p class="mt-1 text-4xl font-bold text-slate-900">{{ company_score|default:"â€”" }}</p>
            <p class="text-xs text-slate-500">prÅ¯mÄ›r z poslednÃ­ho dotaznÃ­ku</p>
          </div>
          {% if score_trend %}{% with trend=score_trend %}
          <div class="text-right">
            <span class="inline-flex items-center gap-1 text-sm font-semibold {% if trend > 0 %}text-emerald-600{% elif trend < 0 %}text-rose-600{% else %}text-slate-500{% endif %}">
              {% if trend > 0 %}â–²{% elif trend < 0 %}â–¼{% else %}â–¬{% endif %}
              {{ trend|floatformat:1 }} bodÅ¯
            </span>
            <p class="text-xs text-slate-400">vs. pÅ™edchozÃ­ mÄ›Å™enÃ­</p>
          </div>
          {% endwith %}{% endif %}
        </div>
        <div class="h-16">
          <canvas id="scoreSparkline"></canvas>
        </div>
        <p class="text-xs text-slate-500">Sleduj trend alespoÅˆ mÄ›sÃ­ÄnÄ›, aby Å¡lo zachytit zmÄ›ny vÄas.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">NÃ¡lada tÃ½mu</p>
            <h2 class="mt-2 text-2xl font-semibold {% if mood_tone == 'positive' %}text-emerald-600{% elif mood_tone == 'negative' %}text-rose-600{% else %}text-indigo-500{% endif %}">{{ mood_label }}</h2>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {% if mood_tone == 'positive' %}bg-emerald-100 text-emerald-700{% elif mood_tone == 'negative' %}bg-rose-100 text-rose-600{% else %}bg-indigo-100 text-indigo-600{% endif %}">
            {% if mood_tone == 'positive' %}ğŸ˜Š{% elif mood_tone == 'negative' %}âš ï¸{% else %}ğŸ™‚{% endif %}
            Stav tÃ½mu
          </span>
        </div>
        <p class="text-sm text-slate-600 leading-relaxed">{{ mood_description }}</p>
        <p class="text-xs text-slate-400">NÃ¡lada se odvÃ­jÃ­ od numerickÃ©ho skÃ³re i sentimentu odpovÄ›dÃ­.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">DoporuÄenÃ­ kouÄe</p>
          <h2 class="mt-2 text-2xl font-semibold text-slate-900">DalÅ¡Ã­ kroky</h2>
        </div>
        {% if recommendation_points %}
        <ul class="space-y-3 text-sm text-slate-600">
          {% for item in recommendation_points %}
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 rounded-full bg-sky-500"></span>
            <span>{{ item }}</span>
          </li>
          {% endfor %}
        </ul>
        {% elif coach_recommendation %}
        <p class="text-sm text-slate-600 leading-relaxed">{{ coach_recommendation }}</p>
        {% else %}
        <p class="text-sm text-slate-500">AÅ¾ odeÅ¡leÅ¡ prvnÃ­ dotaznÃ­k nebo otevÅ™enou analÃ½zu, zobrazÃ­me doporuÄenÃ­ kouÄe.</p>
        {% endif %}
      </section>

      <section class="dashboard-card xl:col-span-4 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">MeziroÄnÃ­ vÃ½voj</p>
            <h2 class="mt-2 text-2xl font-semibold text-slate-900">FinanÄnÃ­ trajektorie</h2>
          </div>
          <div class="flex flex-wrap items-center gap-3 dashboard-actions">
            <button type="button" class="scb-btn scb-btn-primary" id="chart-export-trigger">ğŸ“¥ PÅ™ipravit grafy pro export</button>
            <span class="dashboard-actions__hint" id="chart-export-status">PÅ™ipravÃ­me grafy a pÅ™esuneme tÄ› k exportu PDF.</span>
          </div>
        </div>
        <div class="h-80">
          <canvas id="metricsTrendChart"></canvas>
        </div>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Kontaktuj kouÄe</p>
          <h2 class="mt-2 text-xl font-semibold text-slate-900">PotÅ™ebujeÅ¡ revizi?</h2>
        </div>
        <form id="coachContactForm" class="space-y-4">
          <textarea id="coachMessage" name="message" rows="4" class="block w-full rounded-2xl border-slate-200 bg-slate-50/70 text-sm text-slate-700 placeholder:text-slate-400 focus:border-sky-500 focus:ring-sky-500" placeholder="Zeptej se kouÄe na konkrÃ©tnÃ­ problÃ©m nebo oblast."></textarea>
          <button type="submit" class="scb-btn scb-btn-primary w-full justify-center">âœ‰ï¸ Odeslat kouÄovi</button>
        </form>
        <p id="coachContactStatus" class="text-xs text-slate-500" data-tone="info">OdpovÄ›Ä od AI vidÃ­Å¡ hned, kouÄ ji dostane do revize.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Revize dashboardu</p>
          <h2 class="mt-2 text-xl font-semibold text-slate-900">PoznÃ¡mky kouÄe</h2>
        </div>
        {% if coach_note %}
          <p class="text-sm text-slate-600 leading-relaxed">{{ coach_note }}</p>
        {% elif assigned_coach %}
          <p class="text-sm text-slate-500">TvÅ¯j kouÄ zatÃ­m nepÅ™idal poznÃ¡mku. Jakmile ji doplnÃ­, objevÃ­ se tady.</p>
        {% else %}
          <p class="text-sm text-slate-500">KdyÅ¾ pÅ™iÅ™adÃ­me kouÄe, zobrazÃ­me jeho zpÄ›tnou vazbu.</p>
        {% endif %}
      </section>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <a href="{% url 'survey:questionnaire' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="Spustit novÃ½ dotaznÃ­k">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">DotaznÃ­ky</p>
            <h3 class="text-lg font-semibold text-slate-900">NovÃ½ dotaznÃ­k</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-100 text-sky-600 text-lg">ğŸ“</span>
        </div>
        <p class="text-sm text-slate-500">OtevÅ™i finanÄnÃ­ dotaznÃ­k a nasbÃ­rej aktuÃ¡lnÃ­ odpovÄ›di od tÃ½mu.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-sky-600 group-hover:text-sky-700">
          Spustit
          <span aria-hidden="true">â†’</span>
        </span>
      </a>
      <a href="{% url 'suropen:form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="NovÃ¡ analÃ½za">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">AnalÃ½zy</p>
            <h3 class="text-lg font-semibold text-slate-900">NovÃ¡ analÃ½za</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 text-lg">ğŸ§ </span>
        </div>
        <p class="text-sm text-slate-500">ProveÄ otevÅ™enou analÃ½zu a zachyÅ¥ bariÃ©ry rÅ¯stu firmy.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-emerald-600 group-hover:text-emerald-700">
          Spustit
          <span aria-hidden="true">â†’</span>
        </span>
      </a>
      <a href="{% url 'exports:export_form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="Export review">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Exporty</p>
            <h3 class="text-lg font-semibold text-slate-900">Export review</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-indigo-100 text-indigo-600 text-lg">ğŸ“„</span>
        </div>
        <p class="text-sm text-slate-500">Vygeneruj nejnovÄ›jÅ¡Ã­ PDF s ÄÃ­sly a pÅ™ehledem vÃ½kazÅ¯.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-indigo-600 group-hover:text-indigo-700">
          OtevÅ™Ã­t
          <span aria-hidden="true">â†’</span>
        </span>
      </a>
    </section>

    <section class="dashboard-card bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Volba roku</p>
          <h2 class="mt-2 text-lg font-semibold text-slate-900">Filtrovat zobrazenÃ© roky</h2>
        </div>
        <div class="flex flex-wrap gap-3">
          {% for r in table_rows %}
          <label class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1.5 text-sm text-slate-700 bg-slate-50/80">
            <input type="checkbox" class="year-filter rounded border-slate-300 text-sky-600 focus:ring-sky-500" value="{{ r.year }}" checked>
            <span>{{ r.year }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="dashboard-card bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Data z nahranÃ½ch vÃ½kazÅ¯</p>
          <h2 class="mt-2 text-lg font-semibold text-slate-900">Stav rozvahy a vÃ½sledovky</h2>
          <p class="text-xs text-slate-500 mt-1">RychlÃ½ pÅ™ehled, jestli mÃ¡me oba typy dokumentÅ¯ pro jednotlivÃ© roky.</p>
        </div>
      </div>
      {% if document_upload_status %}
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50/80 text-slate-500 uppercase tracking-wide text-xs">
            <tr>
              <th scope="col" class="px-4 py-3 text-left">Rok</th>
              <th scope="col" class="px-4 py-3 text-left">Rozvaha</th>
              <th scope="col" class="px-4 py-3 text-left">VÃ½sledovka</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/70 bg-white/80">
            {% for row in document_upload_status %}
            <tr>
              <td class="px-4 py-3 font-medium text-slate-700">{{ row.year }}</td>
              <td class="px-4 py-3">
                {% if row.has_rozvaha %}
                  {% if row.rozvaha_analyzed %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold">Ano</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold">ÄŒekÃ¡ na analÃ½zu</span>
                  {% endif %}
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold">Ne</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                {% if row.has_vysledovka %}
                  {% if row.vysledovka_analyzed %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold">Ano</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold">ÄŒekÃ¡ na analÃ½zu</span>
                  {% endif %}
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold">Ne</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-sm text-slate-500">ZatÃ­m nejsou nahranÃ© Å¾Ã¡dnÃ© rozvahy ani vÃ½sledovky. Nahraj dokumenty v sekci Ingest, aby se pÅ™ehled doplnil.</p>
      {% endif %}
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">VÃ¡Å¡ pÅ™Ã­bÄ›h zisku</h3>
        <p class="text-xs text-slate-500 mb-3">PorovnÃ¡nÃ­ zÃ¡kladnÃ­ch poloÅ¾ek vÃ½sledovky napÅ™Ã­Ä roky.</p>
        <div class="h-72">
          <canvas id="profitStoryChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Trend ziskovosti</h3>
        <p class="text-xs text-slate-500 mb-3">HrubÃ¡, provoznÃ­ a ÄistÃ¡ marÅ¾e v procentech.</p>
        <div class="h-72">
          <canvas id="profitabilityTrendsChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">RÅ¯st trÅ¾eb vs. nÃ¡kladÅ¯ na zboÅ¾Ã­</h3>
        <p class="text-xs text-slate-500 mb-3">PorovnÃ¡nÃ­ meziroÄnÃ­ch rÅ¯stÅ¯ trÅ¾eb a COGS.</p>
        <div class="h-72">
          <canvas id="revCogsGrowthChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">RÅ¯st trÅ¾eb vs. provoznÃ­ch nÃ¡kladÅ¯</h3>
        <p class="text-xs text-slate-500 mb-3">Sleduj tempo nÃ¡kladÅ¯ oproti rÅ¯stu trÅ¾eb.</p>
        <div class="h-72">
          <canvas id="revOverheadsGrowthChart"></canvas>
        </div>
      </div>
      <div class="lg:col-span-2 bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">MeziroÄnÃ­ vÃ½voj hlavnÃ­ch metrik</h3>
        <p class="text-xs text-slate-500 mb-3">VÃ½voj trÅ¾eb, nÃ¡kladÅ¯ a ziskovosti za zvolenÃ© roky.</p>
        <div class="h-80">
          <canvas id="allMetricsChart"></canvas>
        </div>
      </div>
    </section>

    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">ğŸ“‘ PÅ™ehled dat</h3>
          <p class="text-xs text-slate-500">KompletnÃ­ tabulka hlavnÃ­ch finanÄnÃ­ch ukazatelÅ¯.</p>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50/80 text-slate-500 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Rok</th>
              <th class="px-4 py-3 text-right">TrÅ¾by (KÄ)</th>
              <th class="px-4 py-3 text-right">NÃ¡klady na prodanÃ© zboÅ¾Ã­ (KÄ)</th>
              <th class="px-4 py-3 text-right">HrubÃ¡ marÅ¾e (KÄ)</th>
              <th class="px-4 py-3 text-right">ProvoznÃ­ nÃ¡klady (KÄ)</th>
              <th class="px-4 py-3 text-right">EBIT (KÄ)</th>
              <th class="px-4 py-3 text-right">ÄŒistÃ½ zisk (KÄ)</th>
              <th class="px-4 py-3 text-right">HrubÃ¡ marÅ¾e %</th>
              <th class="px-4 py-3 text-right">ProvoznÃ­ marÅ¾e %</th>
              <th class="px-4 py-3 text-right">ÄŒistÃ¡ marÅ¾e %</th>
              <th class="px-4 py-3 text-right">RÅ¯st trÅ¾eb %</th>
              <th class="px-4 py-3 text-right">RÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­ %</th>
              <th class="px-4 py-3 text-right">RÅ¯st provoznÃ­ch nÃ¡kladÅ¯ %</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/70 bg-white/90">
            {% for r in table_rows %}
            <tr class="text-slate-700">
              <td class="px-4 py-3 font-medium text-slate-800">{{ r.year }}</td>
              <td class="px-4 py-3 text-right">{{ r.revenue|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.cogs|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.gross_margin|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.overheads|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.ebit|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.net_profit|default_if_none:"â€“" }}</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.gm_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.op_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.np_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.revenue|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.cogs|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.overheads|floatformat:2 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">ğŸ’° Zisk vs penÄ›Å¾nÃ­ tok</h3>
          <p class="text-xs text-slate-500">PorovnÃ¡nÃ­ ÃºÄetnÃ­ch vÃ½sledkÅ¯ se skuteÄnÃ½m cash flow.</p>
        </div>
        <div class="flex items-center gap-2">
          <label for="cashflow-year-select" class="text-xs uppercase tracking-[0.2em] text-slate-400">Rok</label>
          <select id="cashflow-year-select" class="rounded-xl border-slate-300 text-sm focus:border-sky-500 focus:ring-sky-500">
            {% for r in table_rows %}
              <option value="{{ r.year }}" {% if r.year == selected_year %}selected{% endif %}>{{ r.year }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl" id="cashflow-content">
        {% include 'dashboard/partials/cashflow_table.html' %}
      </div>
    </section>
  </div>
</div>
{% endblock %}
