{% extends "base.html" %}

{% load custom_tags %}
{% block extra_head %}
  <script>
    tailwind.config = {
      corePlugins: {
        preflight: false,
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
{% endblock %}

{% block extra_scripts %}
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    const rows = JSON.parse('{{ rows|escapejs }}');
    const years = JSON.parse('{{ years|escapejs }}');
    const chartSeries = JSON.parse('{{ chart_series|escapejs }}');
    const scoreHistoryData = JSON.parse('{{ score_history|default:"[]"|escapejs }}');

    let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

    // Modern Color Palette - 2025 Design Trends
    const modernColors = {
      // Primary brand colors
      primary: {
        blue: { main: '#3B82F6', light: 'rgba(59, 130, 246, 0.12)', dark: '#2563EB' },
        indigo: { main: '#6366F1', light: 'rgba(99, 102, 241, 0.12)', dark: '#4F46E5' },
        violet: { main: '#8B5CF6', light: 'rgba(139, 92, 246, 0.12)', dark: '#7C3AED' },
      },
      // Success & growth
      success: {
        emerald: { main: '#10B981', light: 'rgba(16, 185, 129, 0.12)', dark: '#059669' },
        teal: { main: '#14B8A6', light: 'rgba(20, 184, 166, 0.12)', dark: '#0D9488' },
        green: { main: '#22C55E', light: 'rgba(34, 197, 94, 0.12)', dark: '#16A34A' },
      },
      // Warning & attention
      warning: {
        amber: { main: '#F59E0B', light: 'rgba(245, 158, 11, 0.12)', dark: '#D97706' },
        orange: { main: '#F97316', light: 'rgba(249, 115, 22, 0.12)', dark: '#EA580C' },
        yellow: { main: '#EAB308', light: 'rgba(234, 179, 8, 0.12)', dark: '#CA8A04' },
      },
      // Danger & costs
      danger: {
        red: { main: '#EF4444', light: 'rgba(239, 68, 68, 0.12)', dark: '#DC2626' },
        rose: { main: '#F43F5E', light: 'rgba(244, 63, 94, 0.12)', dark: '#E11D48' },
      },
      // Neutral & secondary
      neutral: {
        slate: { main: '#64748B', light: 'rgba(100, 116, 139, 0.12)', dark: '#475569' },
        gray: { main: '#6B7280', light: 'rgba(107, 114, 128, 0.12)', dark: '#4B5563' },
      },
      // Multi-year palette (harmonious progression)
      yearPalette: [
        '#3B82F6', // Blue
        '#10B981', // Emerald
        '#F59E0B', // Amber
        '#8B5CF6', // Violet
        '#EF4444', // Red
        '#14B8A6', // Teal
        '#F97316', // Orange
        '#6366F1', // Indigo
      ],
    };

    // Global chart defaults for modern look
    Chart.defaults.font.family = "'Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', sans-serif";
    Chart.defaults.font.size = 13;
    Chart.defaults.color = '#64748B';
    Chart.defaults.borderColor = 'rgba(226, 232, 240, 0.8)';
    Chart.defaults.plugins.legend.labels.padding = 16;
    Chart.defaults.plugins.legend.labels.boxWidth = 12;
    Chart.defaults.plugins.legend.labels.boxHeight = 12;

    // Common chart options for consistency
    const commonChartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: {
          position: 'top',
          align: 'start',
          labels: {
            usePointStyle: true,
            pointStyle: 'circle',
            padding: 20,
            font: { size: 13, weight: '500' },
            color: '#475569',
          },
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#F8FAFC',
          bodyColor: '#E2E8F0',
          borderColor: 'rgba(148, 163, 184, 0.2)',
          borderWidth: 1,
          padding: 12,
          boxPadding: 6,
          usePointStyle: true,
          titleFont: { size: 13, weight: '600' },
          bodyFont: { size: 13 },
          cornerRadius: 8,
        },
      },
      scales: {
        x: {
          grid: {
            display: false,
            drawBorder: false,
          },
          ticks: {
            color: '#64748B',
            font: { size: 12, weight: '500' },
            padding: 8,
          },
        },
        y: {
          grid: {
            color: 'rgba(226, 232, 240, 0.5)',
            drawBorder: false,
          },
          ticks: {
            color: '#64748B',
            font: { size: 12 },
            padding: 8,
          },
          beginAtZero: true,
        },
      },
    };

    function getSelectedYears() {
      const selected = Array.from(document.querySelectorAll('.year-filter:checked')).map((cb) => parseInt(cb.value, 10));
      if (!selected.length) {
        return years.slice();
      }
      return selected;
    }

    function filterRowsByYears(selectedYears) {
      return rows.filter((row) => selectedYears.includes(row.year));
    }

    function destroyIfExists(chart) {
      if (chart && typeof chart.destroy === 'function') {
        chart.destroy();
      }
    }

    function renderCharts() {
      const selectedYears = getSelectedYears();
      const dataRows = filterRowsByYears(selectedYears);
      const labels = dataRows.map((row) => row.year);

      // Profit Story - Modern Design
      destroyIfExists(profitStoryChart);
      profitStoryChart = new Chart(document.getElementById('profitStoryChart'), {
        type: 'bar',
        data: {
          labels: ['Tržby', 'Náklady na prodané zboží', 'Hrubá marže', 'Provozní náklady', 'EBIT', 'Čistý zisk'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
            backgroundColor: modernColors.yearPalette[idx % modernColors.yearPalette.length],
            borderRadius: 8,
            borderSkipped: false,
            maxBarThickness: 48,
            barPercentage: 0.8,
            categoryPercentage: 0.9,
          })),
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                title: (items) => items[0].label,
                label: (item) => `${item.dataset.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} Kč`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M Kč';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K Kč';
                  return Number(value).toLocaleString('cs-CZ') + ' Kč';
                },
              },
            },
          },
        },
      });
      window.profitStoryChart = profitStoryChart;

      // Profitability Trends - Modern Design
      destroyIfExists(profitabilityTrendsChart);
      profitabilityTrendsChart = new Chart(document.getElementById('profitabilityTrendsChart'), {
        type: 'bar',
        data: {
          labels: ['Hrubá marže %', 'Provozní marže %', 'Čistá marže %'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
            backgroundColor: modernColors.yearPalette[idx % modernColors.yearPalette.length],
            borderRadius: 8,
            borderSkipped: false,
            maxBarThickness: 48,
            barPercentage: 0.8,
            categoryPercentage: 0.9,
          })),
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                title: (items) => items[0].label,
                label: (item) => `${item.dataset.label}: ${item.formattedValue}%`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => `${value}%`,
              },
            },
          },
        },
      });
      window.profitabilityTrendsChart = profitabilityTrendsChart;

      // Revenue vs COGS Growth - Modern Design
      const revGrowth = dataRows.map((row) => row.growth.revenue);
      const cogsGrowth = dataRows.map((row) => row.growth.cogs);
      destroyIfExists(revCogsGrowthChart);
      revCogsGrowthChart = new Chart(document.getElementById('revCogsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Růst tržeb (%)',
              data: revGrowth,
              backgroundColor: modernColors.primary.blue.main,
              hoverBackgroundColor: modernColors.primary.blue.dark,
              borderRadius: 8,
              borderSkipped: false,
              maxBarThickness: 52,
            },
            {
              label: 'Růst nákladů na prodané zboží (%)',
              data: cogsGrowth,
              backgroundColor: modernColors.danger.red.main,
              hoverBackgroundColor: modernColors.danger.red.dark,
              borderRadius: 8,
              borderSkipped: false,
              maxBarThickness: 52,
            },
          ],
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                label: (item) => `${item.dataset.label}: ${item.formattedValue}%`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => `${value}%`,
              },
            },
          },
        },
      });
      window.revCogsGrowthChart = revCogsGrowthChart;

      // Revenue vs Overheads Growth - Modern Design
      const overheadGrowth = dataRows.map((row) => row.growth.overheads);
      destroyIfExists(revOverheadsGrowthChart);
      revOverheadsGrowthChart = new Chart(document.getElementById('revOverheadsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Růst tržeb (%)',
              data: revGrowth,
              backgroundColor: modernColors.success.teal.main,
              hoverBackgroundColor: modernColors.success.teal.dark,
              borderRadius: 8,
              borderSkipped: false,
              maxBarThickness: 52,
            },
            {
              label: 'Růst provozních nákladů (%)',
              data: overheadGrowth,
              backgroundColor: modernColors.warning.amber.main,
              hoverBackgroundColor: modernColors.warning.amber.dark,
              borderRadius: 8,
              borderSkipped: false,
              maxBarThickness: 52,
            },
          ],
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                label: (item) => `${item.dataset.label}: ${item.formattedValue}%`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => `${value}%`,
              },
            },
          },
        },
      });
      window.revOverheadsGrowthChart = revOverheadsGrowthChart;

      // All Metrics Chart - Modern Design
      destroyIfExists(allMetricsChart);
      allMetricsChart = new Chart(document.getElementById('allMetricsChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Tržby',
              data: dataRows.map((r) => r.revenue),
              borderColor: modernColors.primary.blue.main,
              backgroundColor: modernColors.primary.blue.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'COGS',
              data: dataRows.map((r) => r.cogs),
              borderColor: modernColors.danger.rose.main,
              backgroundColor: modernColors.danger.rose.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'Hrubá marže',
              data: dataRows.map((r) => r.gross_margin),
              borderColor: modernColors.success.emerald.main,
              backgroundColor: modernColors.success.emerald.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'Provozní náklady',
              data: dataRows.map((r) => r.overheads),
              borderColor: modernColors.warning.amber.main,
              backgroundColor: modernColors.warning.amber.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'EBIT',
              data: dataRows.map((r) => r.ebit),
              borderColor: modernColors.primary.violet.main,
              backgroundColor: modernColors.primary.violet.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'Čistý zisk',
              data: dataRows.map((r) => r.net_profit),
              borderColor: modernColors.success.green.main,
              backgroundColor: modernColors.success.green.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
          ],
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                label: (item) => `${item.dataset.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} Kč`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M Kč';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K Kč';
                  return Number(value).toLocaleString('cs-CZ') + ' Kč';
                },
              },
            },
          },
        },
      });
      window.allMetricsChart = allMetricsChart;
    }

    function renderSparkline() {
      const spark = document.getElementById('scoreSparkline');
      if (!spark || !scoreHistoryData.length) return;
      const sparkChart = new Chart(spark, {
        type: 'line',
        data: {
          labels: scoreHistoryData.map((item) => item.label),
          datasets: [{
            data: scoreHistoryData.map((item) => item.value),
            borderColor: modernColors.primary.indigo.main,
            backgroundColor: modernColors.primary.indigo.light,
            tension: 0.4,
            borderWidth: 2,
            fill: true,
            pointRadius: 0,
            pointHoverRadius: 3,
          }],
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: false,
        },
      });
      window.scoreSparklineChart = sparkChart;
    }

    function renderMiniTrendChart() {
      const ctx = document.getElementById('miniTrendChart');
      if (!ctx || !chartSeries.labels || !chartSeries.labels.length) return;
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartSeries.labels,
          datasets: [
            {
              data: chartSeries.revenue,
              borderColor: modernColors.primary.blue.main,
              backgroundColor: modernColors.primary.blue.light,
              tension: 0.4,
              borderWidth: 2,
              fill: true,
              pointRadius: 0,
            },
            {
              data: chartSeries.net_profit,
              borderColor: modernColors.success.green.main,
              backgroundColor: modernColors.success.green.light,
              tension: 0.4,
              borderWidth: 2,
              fill: true,
              pointRadius: 0,
            },
          ],
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: false,
        },
      });
    }

    function renderMetricTrendChart() {
      const ctx = document.getElementById('metricsTrendChart');
      if (!ctx || !chartSeries.labels || !chartSeries.labels.length) return;
      window.metricsTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartSeries.labels,
          datasets: [
            {
              label: 'Tržby',
              data: chartSeries.revenue,
              borderColor: modernColors.primary.blue.main,
              backgroundColor: modernColors.primary.blue.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'Čistý zisk',
              data: chartSeries.net_profit,
              borderColor: modernColors.success.green.main,
              backgroundColor: modernColors.success.green.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
            {
              label: 'EBIT',
              data: chartSeries.ebit,
              borderColor: modernColors.warning.orange.main,
              backgroundColor: modernColors.warning.orange.light,
              tension: 0.4,
              borderWidth: 2.5,
              fill: true,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: '#FFFFFF',
              pointBorderWidth: 2,
              pointHoverBorderWidth: 3,
            },
          ],
        },
        options: {
          ...commonChartOptions,
          plugins: {
            ...commonChartOptions.plugins,
            tooltip: {
              ...commonChartOptions.plugins.tooltip,
              callbacks: {
                label: (context) => `${context.dataset.label}: ${Number(context.parsed.y || 0).toLocaleString('cs-CZ')} Kč`,
              },
            },
          },
          scales: {
            ...commonChartOptions.scales,
            y: {
              ...commonChartOptions.scales.y,
              ticks: {
                ...commonChartOptions.scales.y.ticks,
                callback: (value) => {
                  if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M Kč';
                  if (value >= 1000) return (value / 1000).toFixed(0) + 'K Kč';
                  return Number(value).toLocaleString('cs-CZ') + ' Kč';
                },
              },
            },
          },
        },
      });
    }

    function getCookie(name) {
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < cookies.length; i += 1) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === `${name}=`) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }

    async function saveChartAsImage(chart, chartId) {
      if (!chart || typeof chart.toBase64Image !== 'function') {
        return;
      }
      if (typeof chart.stop === 'function') {
        chart.stop();
      }
      if (chart.options && chart.options.animation) {
        chart.options.animation = false;
      }
      if (typeof chart.update === 'function') {
        chart.update('none');
      }
      await new Promise((resolve) => requestAnimationFrame(resolve));
      const dataUrl = chart.toBase64Image('image/png', 1);
      if (!dataUrl || dataUrl.length < 100) {
        return;
      }
      try {
        const response = await fetch('{% url "dashboard:save_chart" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ image: dataUrl, chart_id: chartId }),
        });
        const payload = await response.json();
        if (payload.status !== 'ok') {
          console.warn('Nepodařilo se uložit graf:', chartId, payload);
        }
      } catch (error) {
        console.error('Chyba při ukládání grafu', chartId, error);
      }
      await new Promise((resolve) => setTimeout(resolve, 150));
    }

    async function saveAllCharts() {
      const charts = [
        { chart: window.profitStoryChart, id: 'profit_story' },
        { chart: window.profitabilityTrendsChart, id: 'profitability_trends' },
        { chart: window.revCogsGrowthChart, id: 'rev_cogs_growth' },
        { chart: window.revOverheadsGrowthChart, id: 'rev_overheads_growth' },
        { chart: window.allMetricsChart, id: 'all_metrics' },
        { chart: window.metricsTrendChart, id: 'metrics_trend' },
      ];
      for (const cfg of charts) {
        await saveChartAsImage(cfg.chart, cfg.id);
      }
    }

    async function loadCashflowForYear(year) {
      const container = document.getElementById('cashflow-content');
      if (!container || !year) {
        return;
      }
      container.innerHTML = '<div class="py-8 text-center text-sm text-slate-500 bg-white/90">Načítáme peněžní tok…</div>';
      try {
        const response = await fetch(`/dashboard/api/cashflow/${year}/`);
        if (!response.ok) {
          throw new Error('response not ok');
        }
        const html = await response.text();
        container.innerHTML = html;
        if (window.bootstrap) {
          const tooltips = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltips.map((el) => new bootstrap.Tooltip(el));
        }
      } catch (error) {
        console.error('Chyba při načítání cashflow', error);
        container.innerHTML = '<div class="py-8 text-sm text-rose-600 text-center bg-white/90">Nepodařilo se načíst cashflow data. Zkus to prosím znovu.</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCharts();
      renderSparkline();
      renderMiniTrendChart();
      renderMetricTrendChart();

      document.querySelectorAll('.year-filter').forEach((cb) => {
        cb.addEventListener('change', renderCharts);
      });

      if (window.bootstrap) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
      }

      const contactForm = document.getElementById('coachContactForm');
      if (contactForm) {
        const messageInput = document.getElementById('coachMessage');
        const statusEl = document.getElementById('coachContactStatus');
        const sendUrl = contactForm.dataset.sendUrl;
        const setContactStatus = (text, tone = 'info') => {
          statusEl.textContent = text;
          statusEl.classList.remove('text-slate-500', 'text-emerald-600', 'text-rose-600', 'text-amber-600');
          if (tone === 'success') {
            statusEl.classList.add('text-emerald-600');
          } else if (tone === 'error') {
            statusEl.classList.add('text-rose-600');
          } else if (tone === 'warning') {
            statusEl.classList.add('text-amber-600');
          } else {
            statusEl.classList.add('text-slate-500');
          }
        };
        contactForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!sendUrl) {
            setContactStatus('Chybí adresa pro odeslání. Zkus to znovu později.', 'error');
            return;
          }
          const message = (messageInput?.value || '').trim();
          if (!message) {
            setContactStatus('Napiš stručně, s čím potřebuješ pomoct.', 'warning');
            return;
          }
          setContactStatus('Posílám dotaz koučovi…', 'info');
          try {
            const payload = new URLSearchParams();
            payload.append('body', message);
            const response = await fetch(sendUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                'X-CSRFToken': getCookie('csrftoken'),
                'HX-Request': 'true',
              },
              body: payload.toString(),
            });
            if (!response.ok) {
              throw new Error('Chyba při odeslání');
            }
            setContactStatus('Zpráva byla odeslána do Intercomu.', 'success');
            messageInput.value = '';
          } catch (error) {
            setContactStatus('Nepodařilo se odeslat dotaz. Zkus to prosím znovu.', 'error');
            console.error(error);
          }
        });
      }

      const exportBtn = document.getElementById('chart-export-trigger');
      const exportStatus = document.getElementById('chart-export-status');
      const setStatus = (text, tone = 'info') => {
        if (exportStatus) {
          exportStatus.textContent = text;
          exportStatus.dataset.statusTone = tone;
        }
      };

      if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
          if (exportBtn.dataset.busy === '1') {
            return;
          }
          exportBtn.dataset.busy = '1';
          exportBtn.classList.add('is-busy');
          exportBtn.setAttribute('aria-disabled', 'true');
          const originalLabel = exportBtn.innerHTML;
          exportBtn.innerHTML = '⏳ Připravuji grafy…';
          setStatus('Grafy ukládáme. Po dokončení otevřeme export.', 'info');
          await saveAllCharts();
          exportBtn.innerHTML = '✅ Grafy připraveny';
          setStatus('Grafy jsou uložené, pokračuj na export PDF.', 'success');
          setTimeout(() => {
            exportBtn.dataset.busy = '0';
            exportBtn.classList.remove('is-busy');
            exportBtn.removeAttribute('aria-disabled');
            exportBtn.innerHTML = originalLabel;
            window.location.href = '{% url "exports:export_form" %}';
          }, 900);
        });
      }

      const cashflowSelect = document.getElementById('cashflow-year-select');
      if (cashflowSelect) {
        cashflowSelect.addEventListener('change', (event) => loadCashflowForYear(event.target.value));
        if (cashflowSelect.value) {
          loadCashflowForYear(cashflowSelect.value);
        }
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 py-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <header class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">Dashboard</p>
        <h1 class="text-3xl font-bold text-slate-900">Finanční cockpit</h1>
        <p class="text-sm text-slate-500 mt-2">Souhrn zdraví firmy, doporučení a nástroje pro rychlý kontakt s koučem.</p>
      </div>
    </header>

    <!-- METRICKÉ KARTY - 4 v řadě -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
      <!-- Skóre firmy -->
      <div class="dashboard-card bg-white/95 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Skóre firmy</p>
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-sky-100 text-sky-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
          </span>
        </div>
        <div class="flex items-end justify-between">
          <p class="text-3xl font-bold text-slate-900">{{ company_score|default:"—" }}</p>
          {% if score_trend %}{% with trend=score_trend %}
          <span class="inline-flex items-center gap-1 text-xs font-semibold {% if trend > 0 %}text-emerald-600{% elif trend < 0 %}text-rose-600{% else %}text-slate-500{% endif %}">
            {% if trend > 0 %}▲{% elif trend < 0 %}▼{% else %}▬{% endif %}
            {{ trend|floatformat:1 }}
          </span>
          {% endwith %}{% endif %}
        </div>
        <div class="h-10">
          <canvas id="scoreSparkline"></canvas>
        </div>
      </div>

      <!-- Nálada týmu -->
      <div class="dashboard-card bg-white/95 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Nálada týmu</p>
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full {% if mood_tone == 'positive' %}bg-emerald-100 text-emerald-600{% elif mood_tone == 'negative' %}bg-rose-100 text-rose-600{% else %}bg-indigo-100 text-indigo-600{% endif %}">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </span>
        </div>
        <p class="text-2xl font-bold {% if mood_tone == 'positive' %}text-emerald-600{% elif mood_tone == 'negative' %}text-rose-600{% else %}text-indigo-500{% endif %}">{{ mood_label|default:"—" }}</p>
        <p class="text-xs text-slate-500 line-clamp-2">{{ mood_description|default:"Vyplň dotazník pro zobrazení nálady." }}</p>
      </div>

      <!-- Trend - mini graf -->
      <div class="dashboard-card bg-white/95 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Finanční trend</p>
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-violet-100 text-violet-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
          </span>
        </div>
        <div class="flex-1 min-h-[60px]">
          <canvas id="miniTrendChart"></canvas>
        </div>
        <p class="text-xs text-slate-500">Tržby vs. zisk</p>
      </div>

      <!-- Dokumenty - rychlý stav -->
      <div class="dashboard-card bg-white/95 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex flex-col gap-3">
        <div class="flex items-center justify-between">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400">Dokumenty</p>
          <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-amber-100 text-amber-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          </span>
        </div>
        {% if document_upload_status %}
        <div class="flex items-center gap-3">
          <div class="text-center">
            <p class="text-2xl font-bold text-slate-900">{{ document_upload_status|length }}</p>
            <p class="text-[10px] text-slate-400 uppercase">roky</p>
          </div>
          <div class="flex-1 space-y-1">
            {% with first_row=document_upload_status.0 %}
            <div class="flex items-center gap-2 text-xs">
              <span class="w-2 h-2 rounded-full {% if first_row.has_rozvaha and first_row.rozvaha_analyzed %}bg-emerald-500{% elif first_row.has_rozvaha %}bg-amber-500{% else %}bg-rose-400{% endif %}"></span>
              <span class="text-slate-600">Rozvaha {{ first_row.year }}</span>
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="w-2 h-2 rounded-full {% if first_row.has_vysledovka and first_row.vysledovka_analyzed %}bg-emerald-500{% elif first_row.has_vysledovka %}bg-amber-500{% else %}bg-rose-400{% endif %}"></span>
              <span class="text-slate-600">Výsledovka {{ first_row.year }}</span>
            </div>
            {% endwith %}
          </div>
        </div>
        {% else %}
        <p class="text-2xl font-bold text-slate-400">0</p>
        <p class="text-xs text-slate-500">Nahraj dokumenty</p>
        {% endif %}
        <a href="{% url 'ingest:upload_pdf' %}" class="text-xs font-semibold text-sky-600 hover:text-sky-700 mt-auto">Nahrát</a>
      </div>
    </div>

    <!-- HLAVNÍ SEKCE - 2/3 + 1/3 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Doporučení kouče - 2/3 šířky -->
      <section class="lg:col-span-2 dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-5">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Doporučení kouče</p>
            <h2 class="mt-2 text-2xl font-semibold text-slate-900">Další kroky pro růst firmy</h2>
          </div>
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-gradient-to-br from-sky-100 to-indigo-100 text-sky-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
          </span>
        </div>
        {% if recommendation_points %}
        <ul class="space-y-4">
          {% for item in recommendation_points %}
          <li class="flex items-start gap-3 p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-sky-50/50 border border-slate-100">
            <span class="mt-0.5 inline-flex h-6 w-6 items-center justify-center rounded-full bg-sky-500 text-white text-xs font-bold flex-shrink-0">{{ forloop.counter }}</span>
            <span class="text-sm text-slate-700 leading-relaxed">{{ item }}</span>
          </li>
          {% endfor %}
        </ul>
        {% elif coach_recommendation %}
        <div class="p-4 rounded-2xl bg-gradient-to-r from-slate-50 to-sky-50/50 border border-slate-100">
          <p class="text-sm text-slate-700 leading-relaxed">{{ coach_recommendation }}</p>
        </div>
        {% else %}
        <div class="flex-1 flex flex-col items-center justify-center py-8 text-center">
          <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-slate-100 text-slate-400 mb-4">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
          </div>
          <p class="text-sm text-slate-500 max-w-sm">Vyplň první dotazník nebo otevřenou analýzu a kouč ti připraví personalizovaná doporučení.</p>
          <a href="{% url 'survey:questionnaire' %}" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700 transition">
            Spustit dotazník
            <span aria-hidden="true">→</span>
          </a>
        </div>
        {% endif %}

        {% if coach_note %}
        <div class="mt-2 p-4 rounded-2xl bg-amber-50/80 border border-amber-200/60">
          <p class="text-xs uppercase tracking-[0.2em] text-amber-600 mb-2">Poznámka kouče</p>
          <p class="text-sm text-slate-700 leading-relaxed">{{ coach_note }}</p>
        </div>
        {% endif %}
      </section>

      <!-- Kouč + kontakt - 1/3 šířky -->
      <section class="dashboard-card bg-gradient-to-br from-sky-50 via-white to-indigo-50 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-5">
        {% if assigned_coach %}
        {% with coach_user=assigned_coach.user %}
        <div class="text-center">
          <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-sky-500 to-indigo-600 text-white text-2xl font-bold mb-3">
            {{ coach_user.first_name|slice:":1"|default:"K" }}{{ coach_user.last_name|slice:":1" }}
          </div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Tvůj kouč</p>
          <h3 class="text-xl font-semibold text-slate-900 mt-1">
            {{ coach_user.get_full_name|default:coach_user.username|default:assigned_coach }}
          </h3>
          {% if assigned_coach.specialization %}
          <p class="text-sm text-slate-500 mt-1">{{ assigned_coach.specialization }}</p>
          {% endif %}
        </div>

        <div class="space-y-2 text-sm">
          {% if assigned_coach.email or coach_user.email %}
          <div class="flex items-center gap-3 p-2 rounded-xl bg-white/70">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </span>
            <span class="text-slate-700 truncate">{{ assigned_coach.email|default:coach_user.email }}</span>
          </div>
          {% endif %}
          {% if assigned_coach.phone %}
          <div class="flex items-center gap-3 p-2 rounded-xl bg-white/70">
            <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-100 text-slate-500">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            </span>
            <span class="text-slate-700">{{ assigned_coach.phone }}</span>
          </div>
          {% endif %}
        </div>

        <div class="flex gap-2">
          {% if assigned_coach.linkedin %}
          <a href="{{ assigned_coach.linkedin }}" target="_blank" rel="noopener" class="flex-1 inline-flex items-center justify-center gap-1 rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-xs font-medium text-slate-600 hover:text-sky-600 hover:border-sky-200 transition">
            LinkedIn
          </a>
          {% endif %}
          {% if assigned_coach.website %}
          <a href="{{ assigned_coach.website }}" target="_blank" rel="noopener" class="flex-1 inline-flex items-center justify-center gap-1 rounded-xl border border-slate-200 bg-white/80 px-3 py-2 text-xs font-medium text-slate-600 hover:text-sky-600 hover:border-sky-200 transition">
            Web
          </a>
          {% endif %}
        </div>

        <div class="border-t border-slate-200/70 pt-4 mt-auto">
          <p class="text-xs uppercase tracking-[0.2em] text-slate-400 mb-3">Rychlý dotaz</p>
          <form id="coachContactForm" class="space-y-3" data-send-url="{% url 'intercom:send' client_id=request.user.id %}">
            <textarea id="coachMessage" name="message" rows="3" class="block w-full rounded-xl border-slate-200 bg-white/90 text-sm text-slate-700 placeholder:text-slate-400 focus:border-sky-500 focus:ring-sky-500 resize-none" placeholder="Na co se chceš zeptat?"></textarea>
            <button type="submit" class="w-full inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2.5 text-sm font-semibold text-white shadow hover:bg-slate-800 transition">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              Odeslat koučovi
            </button>
          </form>
          <p id="coachContactStatus" class="text-xs text-slate-500 mt-2 text-center">Zpráva se odešle do Intercomu.</p>
        </div>
        {% endwith %}

        {% else %}
        <div class="flex-1 flex flex-col items-center justify-center text-center py-6">
          <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-slate-100 text-slate-400 mb-4">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z"/></svg>
          </div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Tvůj kouč</p>
          <h3 class="text-xl font-semibold text-slate-900 mt-2">Zatím nepřiřazen</h3>
          <p class="text-sm text-slate-500 mt-2 max-w-xs">Jakmile ti tým ScaleupBoard přiřadí kouče, uvidíš zde jeho kontakty.</p>
          <a href="{% url 'suropen:form' %}" class="mt-4 inline-flex items-center gap-2 rounded-xl bg-slate-900 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-slate-800 transition">
            Požádat o kouče
            <span aria-hidden="true">→</span>
          </a>
        </div>
        {% endif %}
      </section>
    </div>

    <!-- RYCHLÉ AKCE + FINANČNÍ GRAF -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Rychlé akce - 3 karty -->
      <a href="{% url 'survey:questionnaire' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex items-center gap-4 text-slate-700 no-underline hover:border-sky-300 hover:shadow-lg transition-all">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-sky-100 text-sky-600 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
        </span>
        <div class="flex-1 min-w-0">
          <h3 class="text-base font-semibold text-slate-900">Nový dotazník</h3>
          <p class="text-xs text-slate-500 truncate">Zhodnoť aktuální stav firmy</p>
        </div>
        <span class="text-sky-600 group-hover:translate-x-1 transition-transform">→</span>
      </a>

      <a href="{% url 'suropen:form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex items-center gap-4 text-slate-700 no-underline hover:border-emerald-300 hover:shadow-lg transition-all">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-100 text-emerald-600 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
        </span>
        <div class="flex-1 min-w-0">
          <h3 class="text-base font-semibold text-slate-900">Analýza růstu</h3>
          <p class="text-xs text-slate-500 truncate">Identifikuj bariéry a příležitosti</p>
        </div>
        <span class="text-emerald-600 group-hover:translate-x-1 transition-transform">→</span>
      </a>

      <a href="{% url 'exports:export_form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-2xl shadow-md shadow-slate-900/5 p-5 flex items-center gap-4 text-slate-700 no-underline hover:border-indigo-300 hover:shadow-lg transition-all">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-indigo-100 text-indigo-600 flex-shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </span>
        <div class="flex-1 min-w-0">
          <h3 class="text-base font-semibold text-slate-900">Export PDF</h3>
          <p class="text-xs text-slate-500 truncate">Vygeneruj přehled pro kouče</p>
        </div>
        <span class="text-indigo-600 group-hover:translate-x-1 transition-transform">→</span>
      </a>
    </div>

    <!-- FINANČNÍ TRAJEKTORIE -->
    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Meziroční vývoj</p>
          <h2 class="mt-2 text-2xl font-semibold text-slate-900">Finanční trajektorie</h2>
        </div>
        <div class="flex flex-wrap items-center gap-3 dashboard-actions">
          <button type="button" class="scb-btn scb-btn-primary" id="chart-export-trigger">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Připravit grafy pro export
          </button>
          <span class="dashboard-actions__hint" id="chart-export-status">Připravíme grafy a přesuneme tě k exportu PDF.</span>
        </div>
      </div>
      <div class="h-80">
        <canvas id="metricsTrendChart"></canvas>
      </div>
    </section>

    <!-- STAV DOKUMENTŮ -->
    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Data z nahraných výkazů</p>
          <h2 class="mt-2 text-lg font-semibold text-slate-900">Stav rozvahy a výsledovky</h2>
        </div>
        <a href="{% url 'ingest:upload_pdf' %}" class="inline-flex items-center gap-2 rounded-xl bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-sky-700 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Nahrát dokument
        </a>
      </div>
      {% if document_upload_status %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {% for row in document_upload_status %}
        <div class="rounded-2xl border border-slate-200/70 bg-slate-50/50 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <span class="text-lg font-bold text-slate-900">{{ row.year }}</span>
            <span class="text-xs text-slate-400">Rok</span>
          </div>
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <span class="text-xs text-slate-600">Rozvaha</span>
              {% if row.has_rozvaha %}
                {% if row.rozvaha_analyzed %}
                  <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-2 py-0.5 text-[10px] font-semibold">OK</span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-2 py-0.5 text-[10px] font-semibold">Ceka</span>
                {% endif %}
              {% else %}
                <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-2 py-0.5 text-[10px] font-semibold">Chybi</span>
              {% endif %}
            </div>
            <div class="flex items-center justify-between">
              <span class="text-xs text-slate-600">Výsledovka</span>
              {% if row.has_vysledovka %}
                {% if row.vysledovka_analyzed %}
                  <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-2 py-0.5 text-[10px] font-semibold">OK</span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-2 py-0.5 text-[10px] font-semibold">Ceka</span>
                {% endif %}
              {% else %}
                <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-2 py-0.5 text-[10px] font-semibold">Chybi</span>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="flex flex-col items-center justify-center py-8 text-center">
        <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-slate-100 text-slate-400 mb-4">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
        </div>
        <p class="text-sm text-slate-500 max-w-sm">Zatím nejsou nahrané žádné rozvahy ani výsledovky.</p>
      </div>
      {% endif %}
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Váš příběh zisku</h3>
        <p class="text-xs text-slate-500 mb-3">Porovnání základních položek výsledovky napříč roky.</p>
        <div class="h-72">
          <canvas id="profitStoryChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Trend ziskovosti</h3>
        <p class="text-xs text-slate-500 mb-3">Hrubá, provozní a čistá marže v procentech.</p>
        <div class="h-72">
          <canvas id="profitabilityTrendsChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Růst tržeb vs. nákladů na zboží</h3>
        <p class="text-xs text-slate-500 mb-3">Porovnání meziročních růstů tržeb a COGS.</p>
        <div class="h-72">
          <canvas id="revCogsGrowthChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Růst tržeb vs. provozních nákladů</h3>
        <p class="text-xs text-slate-500 mb-3">Sleduj tempo nákladů oproti růstu tržeb.</p>
        <div class="h-72">
          <canvas id="revOverheadsGrowthChart"></canvas>
        </div>
      </div>
      <div class="lg:col-span-2 bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Meziroční vývoj hlavních metrik</h3>
        <p class="text-xs text-slate-500 mb-3">Vývoj tržeb, nákladů a ziskovosti za zvolené roky.</p>
        <div class="h-80">
          <canvas id="allMetricsChart"></canvas>
        </div>
      </div>
    </section>
    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">📑 Přehled dat</h3>
          <p class="text-xs text-slate-500">Kompletní tabulka hlavních finančních ukazatelů.</p>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl">
        <table class="w-full divide-y divide-slate-200 text-sm" style="table-layout: auto;">
          <thead class="bg-slate-50/80 text-slate-500 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-3 py-3 text-left">Rok</th>
              <th class="px-2 py-3 text-right">Tržby</th>
              <th class="px-2 py-3 text-right">Náklady na prodané zboží (COGS)</th>
              <th class="px-2 py-3 text-right">Spotřeba materiálu a energie</th>
              <th class="px-2 py-3 text-right">Hrubá marže</th>
              <th class="px-2 py-3 text-right">Provozní náklady</th>
              <th class="px-2 py-3 text-right">EBIT</th>
              <th class="px-2 py-3 text-right">Čistý zisk</th>
              <th class="px-2 py-3 text-right">Hrubá marže %</th>
              <th class="px-2 py-3 text-right">Provozní marže %</th>
              <th class="px-2 py-3 text-right">Čistá marže %</th>
              <th class="px-2 py-3 text-right">Růst tržeb %</th>
              <th class="px-2 py-3 text-right">Růst COGS %</th>
              <th class="px-2 py-3 text-right">Růst prov. nákladů %</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/70 bg-white/90">
            {% for r in table_rows %}
            <tr class="text-slate-700 hover:bg-slate-50/50 transition-colors">
              <td class="px-3 py-2.5 font-medium text-slate-800">{{ r.year }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.revenue|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.cogs|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.cogs_materials|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.gross_margin|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.overheads|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.ebit|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.net_profit|format_kc }}</td>
              <td class="px-2 py-2.5 text-right">{{ r.profitability.gm_pct|floatformat:2 }}%</td>
              <td class="px-2 py-2.5 text-right">{{ r.profitability.op_pct|floatformat:2 }}%</td>
              <td class="px-2 py-2.5 text-right">{{ r.profitability.np_pct|floatformat:2 }}%</td>
              <td class="px-2 py-2.5 text-right">
                {% if r.growth.revenue is not None %}
                  {{ r.growth.revenue|floatformat:2 }}%
                {% else %}
                  <span class="text-slate-400">–</span>
                {% endif %}
              </td>
              <td class="px-2 py-2.5 text-right">
                {% if r.growth.cogs is not None %}
                  {{ r.growth.cogs|floatformat:2 }}%
                {% else %}
                  <span class="text-slate-400">–</span>
                {% endif %}
              </td>
              <td class="px-2 py-2.5 text-right">
                {% if r.growth.overheads is not None %}
                  {{ r.growth.overheads|floatformat:2 }}%
                {% else %}
                  <span class="text-slate-400">–</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">💰 Zisk vs peněžní tok</h3>
          <p class="text-xs text-slate-500">Porovnání účetních výsledků se skutečným cash flow.</p>
        </div>
        <div class="flex items-center gap-2">
          <label for="cashflow-year-select" class="text-xs uppercase tracking-[0.2em] text-slate-400">Rok</label>
          <select id="cashflow-year-select" class="rounded-xl border-slate-300 text-sm focus:border-sky-500 focus:ring-sky-500">
            {% for r in table_rows %}
              <option value="{{ r.year }}" {% if r.year == selected_year %}selected{% endif %}>{{ r.year }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl" id="cashflow-content">
        {% include 'dashboard/partials/cashflow_table.html' %}
      </div>
    </section>
  </div>
</div>
{% endblock %}


