{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>ğŸ“Š Dashboard</h2>

  <!-- FiltrovÃ¡nÃ­ rokÅ¯ -->
  <div class="mb-3">
    <strong>Vyber roky:</strong><br>
    {% for r in table_rows %}
      <label class="me-2">
        <input type="checkbox" class="year-filter" value="{{ r.year }}" checked>
        {{ r.year }}
      </label>
    {% endfor %}
  </div>

  <!-- Grafy -->
  <h3>VÃ¡Å¡ pÅ™Ã­bÄ›h zisku</h3>
  <canvas id="profitStoryChart"></canvas>

  <h3 class="mt-5">Trend ziskovosti</h3>
  <canvas id="profitabilityTrendsChart"></canvas>

  <h3 class="mt-5">RÅ¯st trÅ¾eb vs. rÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­</h3>
  <canvas id="revCogsGrowthChart"></canvas>

  <h3 class="mt-5">RÅ¯st trÅ¾eb vs. rÅ¯st provoznÃ­ch nÃ¡kladÅ¯</h3>
  <canvas id="revOverheadsGrowthChart"></canvas>



  <!-- TabulkovÃ½ pÅ™ehled -->
  <h3 class="mt-5">ğŸ“‘ PÅ™ehled dat</h3>
  <table class="table table-bordered align-middle text-center">
  <thead class="table-light">
    <tr>
      <th>
        Rok
        <span data-bs-toggle="tooltip" title="Rok, ke kterÃ©mu se vztahujÃ­ finanÄnÃ­ vÃ½sledky.">â“</span>
      </th>
      <th>
        TrÅ¾by (KÄ)
        <span data-bs-toggle="tooltip" title="CelkovÃ© vÃ½nosy z prodeje zboÅ¾Ã­ nebo sluÅ¾eb (Revenue).">â“</span>
      </th>
      <th>
        NÃ¡klady na prodanÃ© zboÅ¾Ã­ (KÄ)
        <span data-bs-toggle="tooltip" title="NÃ¡klady spojenÃ© pÅ™Ã­mo s vÃ½robou nebo nÃ¡kupem prodanÃ©ho zboÅ¾Ã­ (COGS).">â“</span>
      </th>
      <th>
        HrubÃ¡ marÅ¾e (KÄ)
        <span data-bs-toggle="tooltip" title="RozdÃ­l mezi trÅ¾bami a nÃ¡klady na prodanÃ© zboÅ¾Ã­ (Revenue - COGS).">â“</span>
      </th>
      <th>
        ProvoznÃ­ nÃ¡klady (KÄ)
        <span data-bs-toggle="tooltip" title="FixnÃ­ a variabilnÃ­ nÃ¡klady na provoz firmy (Overheads).">â“</span>
      </th>
      <th>
        EBIT (KÄ)
        <span data-bs-toggle="tooltip" title="Zisk pÅ™ed Ãºroky a zdanÄ›nÃ­m â€“ ukazatel provoznÃ­ vÃ½konnosti firmy.">â“</span>
      </th>
      <th>
        ÄŒistÃ½ zisk (KÄ)
        <span data-bs-toggle="tooltip" title="Zisk po zdanÄ›nÃ­, finÃ¡lnÃ­ hospodÃ¡Å™skÃ½ vÃ½sledek (Net Profit).">â“</span>
      </th>
      <th>
        HrubÃ¡ marÅ¾e %
        <span data-bs-toggle="tooltip" title="PodÃ­l hrubÃ© marÅ¾e na trÅ¾bÃ¡ch: (HrubÃ¡ marÅ¾e / TrÅ¾by) Ã— 100.">â“</span>
      </th>
      <th>
        ProvoznÃ­ marÅ¾e %
        <span data-bs-toggle="tooltip" title="PodÃ­l EBIT na trÅ¾bÃ¡ch: (EBIT / TrÅ¾by) Ã— 100.">â“</span>
      </th>
      <th>
        ÄŒistÃ¡ marÅ¾e %
        <span data-bs-toggle="tooltip" title="PodÃ­l ÄistÃ©ho zisku na trÅ¾bÃ¡ch: (ÄŒistÃ½ zisk / TrÅ¾by) Ã— 100.">â“</span>
      </th>
      <th>
        RÅ¯st trÅ¾eb %
        <span data-bs-toggle="tooltip" title="MeziroÄnÃ­ zmÄ›na trÅ¾eb oproti pÅ™edchozÃ­mu roku.">â“</span>
      </th>
      <th>
        RÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­ %
        <span data-bs-toggle="tooltip" title="MeziroÄnÃ­ zmÄ›na nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­.">â“</span>
      </th>
      <th>
        RÅ¯st provoznÃ­ch nÃ¡kladÅ¯ %
        <span data-bs-toggle="tooltip" title="MeziroÄnÃ­ zmÄ›na provoznÃ­ch nÃ¡kladÅ¯.">â“</span>
      </th>
    </tr>
  </thead>
  <tbody>
    {% for r in table_rows %}
    <tr>
      <td>{{ r.year }}</td>
      <td>{{ r.revenue }}</td>
      <td>{{ r.cogs }}</td>
      <td>{{ r.gross_margin }}</td>
      <td>{{ r.overheads }}</td>
      <td>{{ r.ebit }}</td>
      <td>{{ r.net_profit }}</td>
      <td>{{ r.profitability.gm_pct|floatformat:2 }}%</td>
      <td>{{ r.profitability.op_pct|floatformat:2 }}%</td>
      <td>{{ r.profitability.np_pct|floatformat:2 }}%</td>
      <td>{{ r.growth.revenue|floatformat:2 }}%</td>
      <td>{{ r.growth.cogs|floatformat:2 }}%</td>
      <td>{{ r.growth.overheads|floatformat:2 }}%</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- Bootstrap JS (nutnÃ© pro tooltipy) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Aktivace Bootstrap tooltipÅ¯ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
  });
</script>

  <!-- Line chart pro vÅ¡echny metriky -->
  <h3 class="mt-5">ğŸ“ˆ MeziroÄnÃ­ pÅ™ehled</h3>
  <canvas id="allMetricsChart"></canvas>
 <!-- ğŸ’° PÅ™ehled Cash Flow -->
<div class="d-flex justify-content-between align-items-center mt-5 mb-3">
  <h3 class="mb-0">ğŸ’° VÃ½kaz Cash Flow</h3>
  <div class="d-flex align-items-center">
    <label for="cashflow-year-select" class="form-label me-2 mb-0"><strong>Rok:</strong></label>
    <select id="cashflow-year-select" class="form-select" style="width: auto;" onchange="loadCashflowForYear(this.value)">
      {% for r in table_rows %}
        <option value="{{ r.year }}" {% if r.year == selected_year %}selected{% endif %}>{{ r.year }}</option>
      {% endfor %}
    </select>
  </div>
</div>

<div id="cashflow-content">
{% if cashflow %}
  <table class="table table-bordered align-middle mt-3">
    <thead class="table-dark text-center">
      <tr>
        <th>PoloÅ¾ka</th>
        <th>ÄŒÃ¡stka (KÄ)</th>
      </tr>
    </thead>
    <tbody>
      <!-- ProvoznÃ­ Äinnost -->
      <tr class="table-secondary"><td colspan="2"><strong>ğŸ”¹ Cash Flow z provoznÃ­ Äinnosti</strong></td></tr>
      <tr><td>Zisk po zdanÄ›nÃ­</td><td class="text-end">{{ cashflow.net_profit|floatformat:0 }}</td></tr>
      <tr><td>Odpisy</td><td class="text-end">{{ cashflow.depreciation|floatformat:0 }}</td></tr>
      <tr><td>ZmÄ›na pracovnÃ­ho kapitÃ¡lu</td><td class="text-end">{{ cashflow.working_capital_change|floatformat:0 }}</td></tr>
      <tr><td>Ãšroky zaplacenÃ©</td><td class="text-end">{{ cashflow.interest_paid|floatformat:0 }}</td></tr>
      <tr><td>DaÅˆ z pÅ™Ã­jmÅ¯ zaplacenÃ¡</td><td class="text-end">{{ cashflow.income_tax_paid|floatformat:0 }}</td></tr>
      <tr><td><strong>ğŸ’¼ ÄŒistÃ© CF z provoznÃ­ Äinnosti</strong></td><td class="text-end"><strong>{{ cashflow.operating_cf|floatformat:0 }}</strong></td></tr>

      <!-- InvestiÄnÃ­ Äinnost -->
      <tr class="table-secondary"><td colspan="2"><strong>ğŸ”¹ Cash Flow z investiÄnÃ­ Äinnosti</strong></td></tr>
      <tr><td>NÃ¡kup dlouhodobÃ©ho majetku (CapEx)</td><td class="text-end">{{ cashflow.capex|floatformat:0 }}</td></tr>
      <tr><td>Prodej dlouhodobÃ©ho majetku</td><td class="text-end">{{ cashflow.asset_sales|floatformat:0 }}</td></tr>
      <tr><td><strong>ğŸ—ï¸ ÄŒistÃ© CF z investiÄnÃ­ Äinnosti</strong></td><td class="text-end"><strong>{{ cashflow.investing_cf|floatformat:0 }}</strong></td></tr>

      <!-- FinanÄnÃ­ Äinnost -->
      <tr class="table-secondary"><td colspan="2"><strong>ğŸ”¹ Cash Flow z finanÄnÃ­ Äinnosti</strong></td></tr>
      <tr><td>NovÃ© ÃºvÄ›ry</td><td class="text-end">{{ cashflow.loans_received|floatformat:0 }}</td></tr>
      <tr><td>SplacenÃ© ÃºvÄ›ry</td><td class="text-end">{{ cashflow.loans_repaid|floatformat:0 }}</td></tr>
      <tr><td>VyplacenÃ© dividendy</td><td class="text-end">{{ cashflow.dividends_paid|floatformat:0 }}</td></tr>
      <tr><td><strong>ğŸ¦ ÄŒistÃ© CF z finanÄnÃ­ Äinnosti</strong></td><td class="text-end"><strong>{{ cashflow.financing_cf|floatformat:0 }}</strong></td></tr>

      <!-- Souhrn -->
      <tr class="table-dark">
        <td><strong>ğŸ’° CelkovÃ¡ zmÄ›na penÄ›Å¾nÃ­ch prostÅ™edkÅ¯</strong></td>
        <td class="text-end"><strong>{{ cashflow.net_cash_flow|floatformat:0 }}</strong></td>
      </tr>
      <tr>
        <td>PoÄÃ¡teÄnÃ­ stav hotovosti</td>
        <td class="text-end">{{ cashflow.cash_begin|floatformat:0 }}</td>
      </tr>
      <tr>
        <td>KoneÄnÃ½ stav hotovosti</td>
        <td class="text-end"><strong>{{ cashflow.cash_end|floatformat:0 }}</strong></td>
      </tr>
    </tbody>
  </table>
{% else %}
  <div class="alert alert-warning mt-3">
    âš ï¸ Cash Flow zatÃ­m nebylo moÅ¾nÃ© vypoÄÃ­tat â€“ zkontrolujte, Å¾e mÃ¡te nahranÃ© vÃ½kazy pro vybranÃ½ rok.
  </div>
{% endif %}
</div> <!-- konec cashflow-content -->

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =======================
// ğŸŒ ÄŒeskÃ¡ lokalizace Chart.js
// =======================
Chart.defaults.locale = 'cs';
Chart.defaults.font.family = 'DejaVu Sans, Arial, Verdana, sans-serif';
Chart.defaults.color = '#222';

// Aktivace tooltipÅ¯ (Bootstrap)
document.addEventListener("DOMContentLoaded", function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// ===== CASHFLOW FUNCTIONS =====
async function loadCashflowForYear(year) {
  try {
    const response = await fetch(`/dashboard/api/cashflow/${year}/`);
    if (response.ok) {
      const html = await response.text();
      document.getElementById('cashflow-content').innerHTML = html;
      
      // Znovu aktivujeme tooltips pro novÃ½ obsah
      const tooltipTriggerList = document.querySelectorAll('#cashflow-content [data-bs-toggle="tooltip"]');
      [...tooltipTriggerList].map(el => new bootstrap.Tooltip(el));
    } else {
      document.getElementById('cashflow-content').innerHTML = 
        '<div class="alert alert-danger">âš ï¸ NepodaÅ™ilo se naÄÃ­st cashflow data pro rok ' + year + '</div>';
    }
  } catch (error) {
    console.error('Chyba pÅ™i naÄÃ­tÃ¡nÃ­ cashflow:', error);
    document.getElementById('cashflow-content').innerHTML = 
      '<div class="alert alert-danger">âš ï¸ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ cashflow dat</div>';
  }
}

// ===== DATA =====
const rows = {{ rows|safe }};
const years = {{ years|safe }};

function getSelectedYears() {
  return Array.from(document.querySelectorAll(".year-filter:checked")).map(cb => parseInt(cb.value));
}
function filterRowsByYears(selectedYears) {
  return rows.filter(r => selectedYears.includes(r.year));
}

let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

function renderCharts() {
  const selectedYears = getSelectedYears();
  const dataRows = filterRowsByYears(selectedYears);
  const labels = dataRows.map(r => r.year);

  // ========================
  // ğŸ“ˆ VÃ¡Å¡ pÅ™Ã­bÄ›h zisku
  // ========================
  const categories = ["TrÅ¾by", "NÃ¡klady na prodanÃ© zboÅ¾Ã­", "HrubÃ¡ marÅ¾e", "ProvoznÃ­ nÃ¡klady", "EBIT", "ÄŒistÃ½ zisk"];
  const datasets = dataRows.map((row, idx) => ({
    label: row.year,
    data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
    backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
  }));
  if (profitStoryChart) profitStoryChart.destroy();
  profitStoryChart = new Chart(document.getElementById("profitStoryChart"), {
    type: "bar",
    data: { labels: categories, datasets },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "VÃ¡Å¡ pÅ™Ã­bÄ›h zisku (Profit Story)",
          font: { size: 18, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: (item) => `${item.label}: ${item.formattedValue.toLocaleString('cs-CZ')} KÄ`
          }
        },
        legend: { position: "top" }
      },
      scales: {
        y: {
          title: { display: true, text: "Hodnota (KÄ)" },
          ticks: { callback: (v) => v.toLocaleString('cs-CZ') }
        }
      }
    }
  });

  // ========================
  // ğŸ“Š Trend ziskovosti
  // ========================
  const datasetsTrends = dataRows.map((row, idx) => ({
    label: row.year,
    data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
    backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
  }));
  if (profitabilityTrendsChart) profitabilityTrendsChart.destroy();
  profitabilityTrendsChart = new Chart(document.getElementById("profitabilityTrendsChart"), {
    type: "bar",
    data: { labels: ["HrubÃ¡ marÅ¾e %", "ProvoznÃ­ marÅ¾e %", "ÄŒistÃ¡ marÅ¾e %"], datasets: datasetsTrends },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Trend ziskovosti", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.label}: ${item.formattedValue}%` } },
        legend: { position: "top" }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // ğŸ“ˆ RÅ¯st trÅ¾eb vs. COGS
  // ========================
  const revGrowth = dataRows.map(r => r.growth.revenue);
  const cogsGrowth = dataRows.map(r => r.growth.cogs);
  if (revCogsGrowthChart) revCogsGrowthChart.destroy();
  revCogsGrowthChart = new Chart(document.getElementById("revCogsGrowthChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "RÅ¯st trÅ¾eb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
        { label: "RÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­ (%)", data: cogsGrowth, backgroundColor: "rgba(255,99,132,0.7)" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "RÅ¯st trÅ¾eb vs. rÅ¯st nÃ¡kladÅ¯ na prodanÃ© zboÅ¾Ã­", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // ğŸ“ˆ RÅ¯st trÅ¾eb vs. provoznÃ­ nÃ¡klady
  // ========================
  const overheadsGrowth = dataRows.map(r => r.growth.overheads);
  if (revOverheadsGrowthChart) revOverheadsGrowthChart.destroy();
  revOverheadsGrowthChart = new Chart(document.getElementById("revOverheadsGrowthChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "RÅ¯st trÅ¾eb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
        { label: "RÅ¯st provoznÃ­ch nÃ¡kladÅ¯ (%)", data: overheadsGrowth, backgroundColor: "rgba(255,206,86,0.7)" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "RÅ¯st trÅ¾eb vs. rÅ¯st provoznÃ­ch nÃ¡kladÅ¯", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // ğŸ“Š MeziroÄnÃ­ pÅ™ehled (All Metrics)
  // ========================
  if (allMetricsChart) allMetricsChart.destroy();
  allMetricsChart = new Chart(document.getElementById("allMetricsChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "TrÅ¾by", data: dataRows.map(r => r.revenue), borderColor: "blue", tension: 0.3 },
        { label: "COGS (nÃ¡klady na prodanÃ© zboÅ¾Ã­)", data: dataRows.map(r => r.cogs), borderColor: "red", tension: 0.3 },
        { label: "HrubÃ¡ marÅ¾e", data: dataRows.map(r => r.gross_margin), borderColor: "green", tension: 0.3 },
        { label: "ProvoznÃ­ nÃ¡klady", data: dataRows.map(r => r.overheads), borderColor: "orange", tension: 0.3 },
        { label: "EBIT", data: dataRows.map(r => r.ebit), borderColor: "purple", tension: 0.3 },
        { label: "ÄŒistÃ½ zisk", data: dataRows.map(r => r.net_profit), borderColor: "brown", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "MeziroÄnÃ­ vÃ½voj hlavnÃ­ch metrik", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue.toLocaleString('cs-CZ')} KÄ` } },
        legend: { position: "top" }
      },
      scales: {
        y: { ticks: { callback: (v) => v.toLocaleString('cs-CZ') + " KÄ" } }
      }
    }
  });
}

document.querySelectorAll(".year-filter").forEach(cb => cb.addEventListener("change", renderCharts));
renderCharts();
</script>
<script>
// ===== EXPORT FUNKCE =====

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// =============================
// ğŸ’¾ UloÅ¾enÃ­ jednoho grafu
// =============================
async function saveChartAsImage(chart, chartId) {
  if (!chart) {
    console.warn(`âš ï¸ Graf ${chartId} nebyl nalezen.`);
    return;
  }

  const imgData = chart.toBase64Image();

  if (!imgData || imgData.length < 100) {
    console.error(`âŒ Graf ${chartId} je prÃ¡zdnÃ½ nebo neplatnÃ½.`);
    return;
  }

  try {
    const response = await fetch("/dashboard/save_chart/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({
        image: imgData,
        chart_id: chartId
      })
    });

    const text = await response.text(); // naÄteme i v pÅ™Ã­padÄ› chyby
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      console.error("âš ï¸ Server nevrÃ¡til JSON:", text);
      return;
    }

    if (data.status !== "ok") {
      console.error(`âŒ Chyba pÅ™i uklÃ¡dÃ¡nÃ­ grafu ${chartId}:`, data.message);
    } else {
      console.log(`âœ… Graf uloÅ¾en:`, data.file);
    }

    await new Promise(resolve => setTimeout(resolve, 150)); // krÃ¡tkÃ¡ pauza
  } catch (e) {
    console.error("âŒ Fetch error:", e);
  }
}

// =============================
// ğŸ’¾ UloÅ¾enÃ­ vÅ¡ech grafÅ¯
// =============================
async function saveAllCharts() {
  const charts = [
    { chart: profitStoryChart, id: "profit_story" },
    { chart: profitabilityTrendsChart, id: "profitability_trends" },
    { chart: revCogsGrowthChart, id: "rev_cogs_growth" },
    { chart: revOverheadsGrowthChart, id: "rev_overheads_growth" },
    { chart: allMetricsChart, id: "all_metrics" }
  ];

  console.log(`ğŸŸ¡ NahrÃ¡vÃ¡m ${charts.length} grafÅ¯â€¦`);
  for (const c of charts) {
    await saveChartAsImage(c.chart, c.id);
  }
  console.log("âœ… VÅ¡echny grafy odeslÃ¡ny!");
}

// =============================
// ğŸ“¤ TlaÄÃ­tko exportu
// =============================
document.addEventListener("DOMContentLoaded", () => {
  const exportBtn = document.createElement("button");
  exportBtn.textContent = "ğŸ’¾ UloÅ¾it grafy do PDF";
  exportBtn.className = "btn btn-primary mt-3";

  exportBtn.onclick = async () => {
    // poÄkej, neÅ¾ se vÅ¡echny grafy domalujÃ­
    setTimeout(async () => {
      await saveAllCharts();
      window.location.href = "/exports/pdf/";
    }, 800);
  };

  document.querySelector(".container").appendChild(exportBtn);
});
</script>
{% endblock %}
