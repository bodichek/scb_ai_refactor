{% extends "base.html" %}

{% block extra_head %}
  <script>
    tailwind.config = {
      corePlugins: {
        preflight: false,
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
{% endblock %}

{% block extra_scripts %}
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    const rows = JSON.parse('{{ rows|escapejs }}');
    const years = JSON.parse('{{ years|escapejs }}');
    const chartSeries = JSON.parse('{{ chart_series|escapejs }}');
    const scoreHistoryData = JSON.parse('{{ score_history|default:"[]"|escapejs }}');

    let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

    function normalizeMetric(value) {
      if (typeof value === 'number' && Number.isFinite(value)) {
        return value;
      }
      if (value === null || value === undefined) {
        return 0;
      }
      let cleaned = String(value).trim();
      if (!cleaned) {
        return 0;
      }
      cleaned = cleaned
        .replace(/\s+/g, '')
        .replace(/[^0-9.,-]/g, '');

      const hasComma = cleaned.includes(',');
      const hasDot = cleaned.includes('.');
      if (hasComma && hasDot) {
        if (cleaned.lastIndexOf(',') > cleaned.lastIndexOf('.')) {
          cleaned = cleaned.replace(/\./g, '').replace(',', '.');
        } else {
          cleaned = cleaned.replace(/,/g, '');
        }
      } else if (hasComma) {
        cleaned = cleaned.replace(',', '.');
      }

      const parsed = Number(cleaned);
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function getSelectedYears() {
      const selected = Array.from(document.querySelectorAll('.year-filter:checked')).map((cb) => parseInt(cb.value, 10));
      if (!selected.length) {
        return years.slice();
      }
      return selected;
    }

    function filterRowsByYears(selectedYears) {
      return rows.filter((row) => selectedYears.includes(row.year));
    }

    function destroyIfExists(chart) {
      if (chart && typeof chart.destroy === 'function') {
        chart.destroy();
      }
    }

    function renderCharts() {
      const selectedYears = getSelectedYears();
      const dataRows = filterRowsByYears(selectedYears);
      const labels = dataRows.map((row) => row.year);

      // Profit Story
      destroyIfExists(profitStoryChart);
      profitStoryChart = new Chart(document.getElementById('profitStoryChart'), {
        type: 'bar',
        data: {
          labels: ['Tržby', 'Náklady na prodané zboží', 'Hrubá marže', 'Provozní náklady', 'EBIT', 'Čistý zisk'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [normalizeMetric(row.revenue), normalizeMetric(row.cogs), normalizeMetric(row.gross_margin), normalizeMetric(row.overheads), normalizeMetric(row.ebit), normalizeMetric(row.net_profit)],
            backgroundColor: `hsl(${(idx * 70) % 360}, 70%, 54%)`,
            borderRadius: 12,
            maxBarThickness: 40,
          })),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: {
              callbacks: {
                label: (item) => `${item.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} Kč`,
              },
            },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: {
              ticks: {
                callback: (value) => Number(value).toLocaleString('cs-CZ'),
              },
            },
          },
        },
      });
      window.profitStoryChart = profitStoryChart;

      // Profitability Trends
      destroyIfExists(profitabilityTrendsChart);
      profitabilityTrendsChart = new Chart(document.getElementById('profitabilityTrendsChart'), {
        type: 'bar',
        data: {
          labels: ['Hrubá marže %', 'Provozní marže %', 'Čistá marže %'],
          datasets: dataRows.map((row, idx) => ({
            label: row.year,
            data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
            backgroundColor: `hsl(${(idx * 70) % 360}, 70%, 54%)`,
            borderRadius: 12,
            maxBarThickness: 40,
          })),
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: { ticks: { callback: (value) => `${value}%` } },
          },
        },
      });
      window.profitabilityTrendsChart = profitabilityTrendsChart;

      // Revenue vs COGS growth
      const revGrowth = dataRows.map((row) => normalizeMetric(row.growth ? row.growth.revenue : 0));
      const cogsGrowth = dataRows.map((row) => normalizeMetric(row.growth ? row.growth.cogs : 0));
      destroyIfExists(revCogsGrowthChart);
      revCogsGrowthChart = new Chart(document.getElementById('revCogsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Růst tržeb (%)', data: revGrowth, backgroundColor: 'rgba(59,130,246,0.75)', borderRadius: 10, maxBarThickness: 42 },
            { label: 'Růst nákladů na prodané zboží (%)', data: cogsGrowth, backgroundColor: 'rgba(248,113,113,0.75)', borderRadius: 10, maxBarThickness: 42 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: { y: { ticks: { callback: (value) => `${value}%` } } },
        },
      });
      window.revCogsGrowthChart = revCogsGrowthChart;

      // Revenue vs overheads growth
      const overheadGrowth = dataRows.map((row) => normalizeMetric(row.growth ? row.growth.overheads : 0));
      destroyIfExists(revOverheadsGrowthChart);
      revOverheadsGrowthChart = new Chart(document.getElementById('revOverheadsGrowthChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Růst tržeb (%)', data: revGrowth, backgroundColor: 'rgba(14,116,144,0.75)', borderRadius: 10, maxBarThickness: 42 },
            { label: 'Růst provozních nákladů (%)', data: overheadGrowth, backgroundColor: 'rgba(250,204,21,0.75)', borderRadius: 10, maxBarThickness: 42 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: { y: { ticks: { callback: (value) => `${value}%` } } },
        },
      });
      window.revOverheadsGrowthChart = revOverheadsGrowthChart;

      // All metrics chart
      destroyIfExists(allMetricsChart);
      allMetricsChart = new Chart(document.getElementById('allMetricsChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Tržby', data: dataRows.map((r) => normalizeMetric(r.revenue)), borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'COGS', data: dataRows.map((r) => normalizeMetric(r.cogs)), borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'Hrubá marže', data: dataRows.map((r) => normalizeMetric(r.gross_margin)), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'Provozní náklady', data: dataRows.map((r) => normalizeMetric(r.overheads)), borderColor: '#facc15', backgroundColor: 'rgba(250,204,21,0.18)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'EBIT', data: dataRows.map((r) => normalizeMetric(r.ebit)), borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
            { label: 'Čistý zisk', data: dataRows.map((r) => normalizeMetric(r.net_profit)), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.15)', tension: 0.35, borderWidth: 3, fill: true, pointRadius: 3 },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: false },
            tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${Number(item.parsed.y).toLocaleString('cs-CZ')} Kč` } },
            legend: { position: 'top', labels: { usePointStyle: true } },
          },
          scales: {
            y: {
              ticks: {
                callback: (value) => Number(value).toLocaleString('cs-CZ') + ' Kč',
              },
            },
          },
        },
      });
      window.allMetricsChart = allMetricsChart;
    }

    function renderSparkline() {
      const spark = document.getElementById('scoreSparkline');
      if (!spark || !scoreHistoryData.length) return;
      const sparkChart = new Chart(spark, {
        type: 'line',
        data: {
          labels: scoreHistoryData.map((item) => item.label),
          datasets: [{
            data: scoreHistoryData.map((item) => item.value),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99,102,241,0.18)',
            tension: 0.4,
            borderWidth: 2,
            fill: true,
            pointRadius: 2,
          }],
        },
        options: {
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: false,
        },
      });
      window.scoreSparklineChart = sparkChart;
    }

    function renderMetricTrendChart() {
      const ctx = document.getElementById('metricsTrendChart');
      if (!ctx || !chartSeries.labels || !chartSeries.labels.length) return;
      window.metricsTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartSeries.labels,
          datasets: [
            {
              label: 'Tržby',
              data: chartSeries.revenue,
              borderColor: '#0a58f5',
              backgroundColor: 'rgba(10, 88, 245, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: 'Čistý zisk',
              data: chartSeries.net_profit,
              borderColor: '#22c55e',
              backgroundColor: 'rgba(34, 197, 94, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
            {
              label: 'EBIT',
              data: chartSeries.ebit,
              borderColor: '#f97316',
              backgroundColor: 'rgba(249, 115, 22, 0.15)',
              tension: 0.35,
              borderWidth: 3,
              fill: true,
              pointRadius: 3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top', labels: { usePointStyle: true } },
            tooltip: {
              callbacks: {
                label: (context) => `${context.dataset.label}: ${Number(context.parsed.y || 0).toLocaleString('cs-CZ')} Kč`,
              },
            },
          },
          scales: {
            y: { ticks: { callback: (value) => Number(value).toLocaleString('cs-CZ') + ' Kč' } },
          },
        },
      });
    }

    function getCookie(name) {
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for (let i = 0; i < cookies.length; i += 1) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === `${name}=`) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }

    async function saveChartAsImage(chart, chartId) {
      if (!chart || typeof chart.toBase64Image !== 'function') {
        return;
      }
      const dataUrl = chart.toBase64Image('image/png', 1);
      if (!dataUrl || dataUrl.length < 100) {
        return;
      }
      try {
        const response = await fetch('{% url "dashboard:save_chart" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ image: dataUrl, chart_id: chartId }),
        });
        const payload = await response.json();
        if (payload.status !== 'ok') {
          console.warn('Nepodařilo se uložit graf:', chartId, payload);
        }
      } catch (error) {
        console.error('Chyba při ukládání grafu', chartId, error);
      }
      await new Promise((resolve) => setTimeout(resolve, 150));
    }

    async function saveAllCharts() {
      const charts = [
        { chart: window.profitStoryChart, id: 'profit_story' },
        { chart: window.profitabilityTrendsChart, id: 'profitability_trends' },
        { chart: window.revCogsGrowthChart, id: 'rev_cogs_growth' },
        { chart: window.revOverheadsGrowthChart, id: 'rev_overheads_growth' },
        { chart: window.allMetricsChart, id: 'all_metrics' },
        { chart: window.metricsTrendChart, id: 'metrics_trend' },
      ];
      for (const cfg of charts) {
        await saveChartAsImage(cfg.chart, cfg.id);
      }
    }

    function formatCoachRecommendation() {
      const container = document.querySelector('[data-coach-recommendation]');
      if (!container) {
        return;
      }
      const rawText = container.textContent || '';
      const trimmed = rawText.trim();
      if (!trimmed) {
        return;
      }

      const cleanupInline = (value) => {
        if (!value) {
          return '';
        }
        return value
          .replace(/\*\*(.+?)\*\*/g, '$1')
          .replace(/__(.+?)__/g, '$1')
          .replace(/`(.+?)`/g, '$1')
          .replace(/\[(.+?)\]\((.+?)\)/g, '$1')
          .replace(/\s+/g, ' ')
          .trim();
      };

      const humanize = (label) => {
        if (!label) {
          return '';
        }
        return label
          .replace(/[\-_]+/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/\b\w/g, (match) => match.toUpperCase())
          .trim();
      };

      const renderMarkdown = (markdown, target) => {
        const lines = markdown.split(/\r?\n+/).map((line) => line.trim()).filter(Boolean);
        if (!lines.length) {
          return;
        }
        let activeList = null;
        let listType = null;

        const closeList = () => {
          if (activeList) {
            target.appendChild(activeList);
            activeList = null;
            listType = null;
          }
        };

        const ensureList = (type) => {
          if (activeList && listType !== type) {
            closeList();
          }
          if (!activeList) {
            activeList = document.createElement(type === 'ol' ? 'ol' : 'ul');
            activeList.className = type === 'ol' ? 'list-decimal pl-5 space-y-2' : 'list-disc pl-5 space-y-2';
            listType = type;
          }
          return activeList;
        };

        const createHeading = (text, level) => {
          const heading = document.createElement(level <= 3 ? 'h4' : 'h5');
          heading.className = 'font-semibold text-slate-800';
          heading.textContent = cleanupInline(text);
          target.appendChild(heading);
        };

        lines.forEach((line) => {
          const headingMatch = line.match(/^#{1,6}\s+(.*)$/);
          if (headingMatch) {
            closeList();
            createHeading(headingMatch[1], headingMatch[0].length);
            return;
          }

          const orderedMatch = line.match(/^(\d+)[\.)]\s+(.*)$/);
          if (orderedMatch) {
            const list = ensureList('ol');
            const li = document.createElement('li');
            li.textContent = cleanupInline(orderedMatch[2]);
            list.appendChild(li);
            return;
          }

          const unorderedMatch = line.match(/^[-*\u2022]\s+(.*)$/);
          if (unorderedMatch) {
            const list = ensureList('ul');
            const li = document.createElement('li');
            li.textContent = cleanupInline(unorderedMatch[1]);
            list.appendChild(li);
            return;
          }

          closeList();
          const paragraph = document.createElement('p');
          paragraph.className = 'text-slate-600';
          paragraph.textContent = cleanupInline(line);
          target.appendChild(paragraph);
        });

        closeList();
      };

      const jsonToMarkdown = (value, depth = 0) => {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
          const textValue = cleanupInline(String(value));
          if (!textValue) {
            return '';
          }
          if (depth === 0) {
            return textValue;
          }
          const indent = '  '.repeat(Math.max(depth - 1, 0));
          return `${indent}- ${textValue}`;
        }
        if (Array.isArray(value)) {
          return value
            .map((item) => jsonToMarkdown(item, depth + 1))
            .filter(Boolean)
            .join('\n');
        }
        if (typeof value === 'object') {
          const sections = [];
          Object.entries(value).forEach(([key, val]) => {
            const headingLevel = Math.min(6, depth + 3);
            const heading = `${'#'.repeat(headingLevel)} ${humanize(key)}`;
            const body = jsonToMarkdown(val, depth + 1);
            sections.push(body ? `${heading}\n${body}` : heading);
          });
          return sections.join('\n');
        }
        return '';
      };

      let structured = null;
      if (/^[\[{]/.test(trimmed)) {
        try {
          structured = JSON.parse(trimmed);
        } catch (error) {
          structured = null;
        }
      }

      const output = document.createElement('div');
      output.className = 'space-y-3';
      container.innerHTML = '';

      if (structured !== null) {
        const markdown = jsonToMarkdown(structured);
        if (markdown && markdown.trim()) {
          renderMarkdown(markdown, output);
        }
      }

      if (!output.hasChildNodes()) {
        renderMarkdown(trimmed, output);
      }

      if (!output.hasChildNodes()) {
        const fallback = document.createElement('p');
        fallback.textContent = cleanupInline(trimmed);
        output.appendChild(fallback);
      }

      container.appendChild(output);
    }
    async function loadCashflowForYear(year) {
      const container = document.getElementById('cashflow-content');
      if (!container || !year) {
        return;
      }
      container.innerHTML = '<div class="py-8 text-center text-sm text-slate-500 bg-white/90">Načítáme peněžní tok…</div>';
      try {
        const response = await fetch(`/dashboard/api/cashflow/${year}/`);
        if (!response.ok) {
          throw new Error('response not ok');
        }
        const html = await response.text();
        container.innerHTML = html;
        if (window.bootstrap) {
          const tooltips = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltips.map((el) => new bootstrap.Tooltip(el));
        }
      } catch (error) {
        console.error('Chyba při načítání cashflow', error);
        container.innerHTML = '<div class="py-8 text-sm text-rose-600 text-center bg-white/90">Nepodařilo se načíst cashflow data. Zkus to prosím znovu.</div>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCharts();
      renderSparkline();
      renderMetricTrendChart();

      document.querySelectorAll('.year-filter').forEach((cb) => {
        cb.addEventListener('change', renderCharts);
      });

      if (window.bootstrap) {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map((tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl));
      }

      formatCoachRecommendation();

      const contactForm = document.getElementById('coachContactForm');
      if (contactForm) {
        const messageInput = document.getElementById('coachMessage');
        const statusEl = document.getElementById('coachContactStatus');
        const setContactStatus = (text, tone = 'info') => {
          statusEl.textContent = text;
          statusEl.classList.remove('text-slate-500', 'text-emerald-600', 'text-rose-600', 'text-amber-600');
          if (tone === 'success') {
            statusEl.classList.add('text-emerald-600');
          } else if (tone === 'error') {
            statusEl.classList.add('text-rose-600');
          } else if (tone === 'warning') {
            statusEl.classList.add('text-amber-600');
          } else {
            statusEl.classList.add('text-slate-500');
          }
        };
        contactForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          const message = (messageInput?.value || '').trim();
          if (!message) {
            setContactStatus('Napiš stručně, s čím potřebuješ pomoct.', 'warning');
            return;
          }
          setContactStatus('Posílám dotaz koučovi…', 'info');
          try {
            const response = await fetch('{% url "dashboard:ask_coach" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
              },
              body: JSON.stringify({ message }),
            });
            const data = await response.json();
            if (!data.success) {
              throw new Error(data.error || 'Chyba při odeslání');
            }
            setContactStatus(data.reply || 'Zpráva byla odeslána.', 'success');
            messageInput.value = '';
          } catch (error) {
            setContactStatus('Nepodařilo se odeslat dotaz. Zkus to prosím znovu.', 'error');
            console.error(error);
          }
        });
      }

      const exportBtn = document.getElementById('chart-export-trigger');
      const exportStatus = document.getElementById('chart-export-status');
      const setStatus = (text, tone = 'info') => {
        if (exportStatus) {
          exportStatus.textContent = text;
          exportStatus.dataset.statusTone = tone;
        }
      };

      if (exportBtn) {
        exportBtn.addEventListener('click', async () => {
          if (exportBtn.dataset.busy === '1') {
            return;
          }
          exportBtn.dataset.busy = '1';
          exportBtn.classList.add('is-busy');
          exportBtn.setAttribute('aria-disabled', 'true');
          const originalLabel = exportBtn.innerHTML;
          exportBtn.innerHTML = '⏳ Připravuji grafy…';
          setStatus('Grafy ukládáme. Po dokončení otevřeme export.', 'info');
          await saveAllCharts();
          exportBtn.innerHTML = '✅ Grafy připraveny';
          setStatus('Grafy jsou uložené, pokračuj na export PDF.', 'success');
          setTimeout(() => {
            exportBtn.dataset.busy = '0';
            exportBtn.classList.remove('is-busy');
            exportBtn.removeAttribute('aria-disabled');
            exportBtn.innerHTML = originalLabel;
            window.location.href = '{% url "exports:export_form" %}';
          }, 900);
        });
      }

      const cashflowSelect = document.getElementById('cashflow-year-select');
      if (cashflowSelect) {
        cashflowSelect.addEventListener('change', (event) => loadCashflowForYear(event.target.value));
        if (cashflowSelect.value) {
          loadCashflowForYear(cashflowSelect.value);
        }
      }
    });
  </script>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 py-10">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <header class="flex flex-col md:flex-row md:items-baseline md:justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-400">Dashboard</p>
        <h1 class="text-3xl font-bold text-slate-900">Finanční cockpit</h1>
        <p class="text-sm text-slate-500 mt-2">Souhrn zdraví firmy, doporučení a nástroje pro rychlý kontakt s koučem.</p>
      </div>
      {% if assigned_coach %}
      <div class="bg-white/85 border border-slate-200/70 rounded-2xl px-4 py-3 shadow-sm">
        <p class="text-xs uppercase tracking-wide text-slate-400">Tvůj kouč</p>
        <p class="text-sm font-semibold text-slate-800">{{ assigned_coach.user.get_full_name|default:assigned_coach }}</p>
        <p class="text-xs text-slate-500">Připraven reagovat na dotazy</p>
      </div>
      {% endif %}
    </header>

    <div class="grid grid-cols-1 xl:grid-cols-6 gap-6">
      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-6">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Skóre firmy</p>
            <p class="mt-1 text-4xl font-bold text-slate-900">{{ company_score|default:"—" }}</p>
            <p class="text-xs text-slate-500">průměr z posledního dotazníku</p>
          </div>
          {% if score_trend %}{% with trend=score_trend %}
          <div class="text-right">
            <span class="inline-flex items-center gap-1 text-sm font-semibold {% if trend > 0 %}text-emerald-600{% elif trend < 0 %}text-rose-600{% else %}text-slate-500{% endif %}">
              {% if trend > 0 %}▲{% elif trend < 0 %}▼{% else %}▬{% endif %}
              {{ trend|floatformat:1 }} bodů
            </span>
            <p class="text-xs text-slate-400">vs. předchozí měření</p>
          </div>
          {% endwith %}{% endif %}
        </div>
        <div class="h-16">
          <canvas id="scoreSparkline"></canvas>
        </div>
        <p class="text-xs text-slate-500">Sleduj trend alespoň měsíčně, aby šlo zachytit změny včas.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Nálada týmu</p>
            <h2 class="mt-2 text-2xl font-semibold {% if mood_tone == 'positive' %}text-emerald-600{% elif mood_tone == 'negative' %}text-rose-600{% else %}text-indigo-500{% endif %}">{{ mood_label }}</h2>
          </div>
          <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {% if mood_tone == 'positive' %}bg-emerald-100 text-emerald-700{% elif mood_tone == 'negative' %}bg-rose-100 text-rose-600{% else %}bg-indigo-100 text-indigo-600{% endif %}">
            {% if mood_tone == 'positive' %}😊{% elif mood_tone == 'negative' %}⚠️{% else %}🙂{% endif %}
            Stav týmu
          </span>
        </div>
        <p class="text-sm text-slate-600 leading-relaxed">{{ mood_description }}</p>
        <p class="text-xs text-slate-400">Nálada se odvíjí od numerického skóre i sentimentu odpovědí.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Doporučení kouče</p>
          <h2 class="mt-2 text-2xl font-semibold text-slate-900">Další kroky</h2>
        </div>
        {% if recommendation_points %}
        <ul class="space-y-3 text-sm text-slate-600">
          {% for item in recommendation_points %}
          <li class="flex items-start gap-2">
            <span class="mt-1 inline-flex h-2.5 w-2.5 rounded-full bg-sky-500"></span>
            <span>{{ item }}</span>
          </li>
          {% endfor %}
        </ul>
        {% elif coach_recommendation %}
        <div class="text-sm text-slate-600 leading-relaxed space-y-2" data-coach-recommendation>{{ coach_recommendation }}</div>
        {% else %}
        <p class="text-sm text-slate-500">Až odešleš první dotazník nebo otevřenou analýzu, zobrazíme doporučení kouče.</p>
        {% endif %}
      </section>

      <section class="dashboard-card xl:col-span-4 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Meziroční vývoj</p>
            <h2 class="mt-2 text-2xl font-semibold text-slate-900">Finanční trajektorie</h2>
          </div>
          <div class="flex flex-wrap items-center gap-3 dashboard-actions">
            <button type="button" class="scb-btn scb-btn-primary" id="chart-export-trigger">📥 Připravit grafy pro export</button>
            <span class="dashboard-actions__hint" id="chart-export-status">Připravíme grafy a přesuneme tě k exportu PDF.</span>
          </div>
        </div>
        <div class="h-80">
          <canvas id="metricsTrendChart"></canvas>
        </div>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Kontaktuj kouče</p>
          <h2 class="mt-2 text-xl font-semibold text-slate-900">Potřebuješ revizi?</h2>
        </div>
        <form id="coachContactForm" class="space-y-4">
          <textarea id="coachMessage" name="message" rows="4" class="block w-full rounded-2xl border-slate-200 bg-slate-50/70 text-sm text-slate-700 placeholder:text-slate-400 focus:border-sky-500 focus:ring-sky-500" placeholder="Zeptej se kouče na konkrétní problém nebo oblast."></textarea>
          <button type="submit" class="scb-btn scb-btn-primary w-full justify-center">✉️ Odeslat koučovi</button>
        </form>
        <p id="coachContactStatus" class="text-xs text-slate-500" data-tone="info">Odpověď od AI vidíš hned, kouč ji dostane do revize.</p>
      </section>

      <section class="dashboard-card xl:col-span-2 bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Revize dashboardu</p>
          <h2 class="mt-2 text-xl font-semibold text-slate-900">Poznámky kouče</h2>
        </div>
        {% if coach_note %}
          <p class="text-sm text-slate-600 leading-relaxed">{{ coach_note }}</p>
        {% elif assigned_coach %}
          <p class="text-sm text-slate-500">Tvůj kouč zatím nepřidal poznámku. Jakmile ji doplní, objeví se tady.</p>
        {% else %}
          <p class="text-sm text-slate-500">Když přiřadíme kouče, zobrazíme jeho zpětnou vazbu.</p>
        {% endif %}
      </section>
    </div>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <a href="{% url 'survey:questionnaire' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="Spustit nový dotazník">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Dotazníky</p>
            <h3 class="text-lg font-semibold text-slate-900">Nový dotazník</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-sky-100 text-sky-600 text-lg">📝</span>
        </div>
        <p class="text-sm text-slate-500">Otevři finanční dotazník a nasbírej aktuální odpovědi od týmu.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-sky-600 group-hover:text-sky-700">
          Spustit
          <span aria-hidden="true">→</span>
        </span>
      </a>
      <a href="{% url 'suropen:form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="Nová analýza">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Analýzy</p>
            <h3 class="text-lg font-semibold text-slate-900">Nová analýza</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-emerald-100 text-emerald-600 text-lg">🧠</span>
        </div>
        <p class="text-sm text-slate-500">Proveď otevřenou analýzu a zachyť bariéry růstu firmy.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-emerald-600 group-hover:text-emerald-700">
          Spustit
          <span aria-hidden="true">→</span>
        </span>
      </a>
      <a href="{% url 'exports:export_form' %}" class="dashboard-card group bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 flex flex-col gap-4 text-slate-700 no-underline" aria-label="Export review">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Exporty</p>
            <h3 class="text-lg font-semibold text-slate-900">Export review</h3>
          </div>
          <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-indigo-100 text-indigo-600 text-lg">📄</span>
        </div>
        <p class="text-sm text-slate-500">Vygeneruj nejnovější PDF s čísly a přehledem výkazů.</p>
        <span class="mt-auto inline-flex items-center gap-1 text-sm font-semibold text-indigo-600 group-hover:text-indigo-700">
          Otevřít
          <span aria-hidden="true">→</span>
        </span>
      </a>
    </section>

    <section class="dashboard-card bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Volba roku</p>
          <h2 class="mt-2 text-lg font-semibold text-slate-900">Filtrovat zobrazené roky</h2>
        </div>
        <div class="flex flex-wrap gap-3">
          {% for r in table_rows %}
          <label class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1.5 text-sm text-slate-700 bg-slate-50/80">
            <input type="checkbox" class="year-filter rounded border-slate-300 text-sky-600 focus:ring-sky-500" value="{{ r.year }}" checked>
            <span>{{ r.year }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
    </section>

    <section class="dashboard-card bg-white/90 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Data z nahraných výkazů</p>
          <h2 class="mt-2 text-lg font-semibold text-slate-900">Stav rozvahy a výsledovky</h2>
          <p class="text-xs text-slate-500 mt-1">Rychlý přehled, jestli máme oba typy dokumentů pro jednotlivé roky.</p>
        </div>
      </div>
      {% if document_upload_status %}
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50/80 text-slate-500 uppercase tracking-wide text-xs">
            <tr>
              <th scope="col" class="px-4 py-3 text-left">Rok</th>
              <th scope="col" class="px-4 py-3 text-left">Rozvaha</th>
              <th scope="col" class="px-4 py-3 text-left">Výsledovka</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/70 bg-white/80">
            {% for row in document_upload_status %}
            <tr>
              <td class="px-4 py-3 font-medium text-slate-700">{{ row.year }}</td>
              <td class="px-4 py-3">
                {% if row.has_rozvaha %}
                  {% if row.rozvaha_analyzed %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold">Ano</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold">Čeká na analýzu</span>
                  {% endif %}
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold">Ne</span>
                {% endif %}
              </td>
              <td class="px-4 py-3">
                {% if row.has_vysledovka %}
                  {% if row.vysledovka_analyzed %}
                    <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-700 px-3 py-1 text-xs font-semibold">Ano</span>
                  {% else %}
                    <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-700 px-3 py-1 text-xs font-semibold">Čeká na analýzu</span>
                  {% endif %}
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-rose-100 text-rose-700 px-3 py-1 text-xs font-semibold">Ne</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-sm text-slate-500">Zatím nejsou nahrané žádné rozvahy ani výsledovky. Nahraj dokumenty v sekci Ingest, aby se přehled doplnil.</p>
      {% endif %}
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Váš příběh zisku</h3>
        <p class="text-xs text-slate-500 mb-3">Porovnání základních položek výsledovky napříč roky.</p>
        <div class="h-72">
          <canvas id="profitStoryChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Trend ziskovosti</h3>
        <p class="text-xs text-slate-500 mb-3">Hrubá, provozní a čistá marže v procentech.</p>
        <div class="h-72">
          <canvas id="profitabilityTrendsChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Růst tržeb vs. nákladů na zboží</h3>
        <p class="text-xs text-slate-500 mb-3">Porovnání meziročních růstů tržeb a COGS.</p>
        <div class="h-72">
          <canvas id="revCogsGrowthChart"></canvas>
        </div>
      </div>
      <div class="bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Růst tržeb vs. provozních nákladů</h3>
        <p class="text-xs text-slate-500 mb-3">Sleduj tempo nákladů oproti růstu tržeb.</p>
        <div class="h-72">
          <canvas id="revOverheadsGrowthChart"></canvas>
        </div>
      </div>
      <div class="lg:col-span-2 bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-5">
        <h3 class="text-lg font-semibold text-slate-900">Meziroční vývoj hlavních metrik</h3>
        <p class="text-xs text-slate-500 mb-3">Vývoj tržeb, nákladů a ziskovosti za zvolené roky.</p>
        <div class="h-80">
          <canvas id="allMetricsChart"></canvas>
        </div>
      </div>
    </section>

    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">📑 Přehled dat</h3>
          <p class="text-xs text-slate-500">Kompletní tabulka hlavních finančních ukazatelů.</p>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl">
        <table class="min-w-full divide-y divide-slate-200 text-sm">
          <thead class="bg-slate-50/80 text-slate-500 uppercase tracking-wide text-xs">
            <tr>
              <th class="px-4 py-3 text-left">Rok</th>
              <th class="px-4 py-3 text-right">Tržby (Kč)</th>
              <th class="px-4 py-3 text-right">Náklady na prodané zboží (Kč)</th>
              <th class="px-4 py-3 text-right">Hrubá marže (Kč)</th>
              <th class="px-4 py-3 text-right">Provozní náklady (Kč)</th>
              <th class="px-4 py-3 text-right">EBIT (Kč)</th>
              <th class="px-4 py-3 text-right">Čistý zisk (Kč)</th>
              <th class="px-4 py-3 text-right">Hrubá marže %</th>
              <th class="px-4 py-3 text-right">Provozní marže %</th>
              <th class="px-4 py-3 text-right">Čistá marže %</th>
              <th class="px-4 py-3 text-right">Růst tržeb %</th>
              <th class="px-4 py-3 text-right">Růst nákladů na prodané zboží %</th>
              <th class="px-4 py-3 text-right">Růst provozních nákladů %</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200/70 bg-white/90">
            {% for r in table_rows %}
            <tr class="text-slate-700">
              <td class="px-4 py-3 font-medium text-slate-800">{{ r.year }}</td>
              <td class="px-4 py-3 text-right">{{ r.revenue|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.cogs|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.gross_margin|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.overheads|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.ebit|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.net_profit|default_if_none:"–" }}</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.gm_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.op_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.profitability.np_pct|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.revenue|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.cogs|floatformat:2 }}%</td>
              <td class="px-4 py-3 text-right">{{ r.growth.overheads|floatformat:2 }}%</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h3 class="text-lg font-semibold text-slate-900">💰 Zisk vs peněžní tok</h3>
          <p class="text-xs text-slate-500">Porovnání účetních výsledků se skutečným cash flow.</p>
        </div>
        <div class="flex items-center gap-2">
          <label for="cashflow-year-select" class="text-xs uppercase tracking-[0.2em] text-slate-400">Rok</label>
          <select id="cashflow-year-select" class="rounded-xl border-slate-300 text-sm focus:border-sky-500 focus:ring-sky-500">
            {% for r in table_rows %}
              <option value="{{ r.year }}" {% if r.year == selected_year %}selected{% endif %}>{{ r.year }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="overflow-hidden border border-slate-200/70 rounded-2xl" id="cashflow-content">
        {% include 'dashboard/partials/cashflow_table.html' %}
      </div>
    </section>
  </div>
</div>
{% endblock %}

