{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>📊 Dashboard</h2>

  <!-- Filtrování roků -->
  <div class="mb-3">
    <strong>Vyber roky:</strong><br>
    {% for r in table_rows %}
      <label class="me-2">
        <input type="checkbox" class="year-filter" value="{{ r.year }}" checked>
        {{ r.year }}
      </label>
    {% endfor %}
  </div>

  <!-- Grafy -->
  <h3>Váš příběh zisku</h3>
  <canvas id="profitStoryChart"></canvas>

  <h3 class="mt-5">Trend ziskovosti</h3>
  <canvas id="profitabilityTrendsChart"></canvas>

  <h3 class="mt-5">Růst tržeb vs. růst nákladů na prodané zboží</h3>
  <canvas id="revCogsGrowthChart"></canvas>

  <h3 class="mt-5">Růst tržeb vs. růst provozních nákladů</h3>
  <canvas id="revOverheadsGrowthChart"></canvas>

  <!-- Tabulkový přehled -->
  <h3 class="mt-5">📑 Přehled dat</h3>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Rok ❓</th>
        <th>Tržby (Kč)</th>
        <th>Náklady na prodané zboží (Kč)</th>
        <th>Hrubá marže (Kč)</th>
        <th>Provozní náklady (Kč)</th>
        <th>EBIT (Kč)</th>
        <th>Čistý zisk (Kč)</th>
        <th>Hrubá marže %</th>
        <th>Provozní marže %</th>
        <th>Čistá marže %</th>
        <th>Růst tržeb %</th>
        <th>Růst nákladů na prodané zboží %</th>
        <th>Růst provozních nákladů %</th>
      </tr>
    </thead>
    <tbody>
      {% for r in table_rows %}
      <tr>
        <td>{{ r.year }}</td>
        <td>{{ r.revenue }}</td>
        <td>{{ r.cogs }}</td>
        <td>{{ r.gross_margin }}</td>
        <td>{{ r.overheads }}</td>
        <td>{{ r.ebit }}</td>
        <td>{{ r.net_profit }}</td>
        <td>{{ r.profitability.gm_pct|floatformat:2 }}%</td>
        <td>{{ r.profitability.op_pct|floatformat:2 }}%</td>
        <td>{{ r.profitability.np_pct|floatformat:2 }}%</td>
        <td>{{ r.growth.revenue|floatformat:2 }}%</td>
        <td>{{ r.growth.cogs|floatformat:2 }}%</td>
        <td>{{ r.growth.overheads|floatformat:2 }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Line chart pro všechny metriky -->
  <h3 class="mt-5">📈 Meziroční přehled</h3>
  <canvas id="allMetricsChart"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// =======================
// 🌍 Česká lokalizace Chart.js
// =======================
Chart.defaults.locale = 'cs';
Chart.defaults.font.family = 'DejaVu Sans, Arial, Verdana, sans-serif';
Chart.defaults.color = '#222';

// Aktivace tooltipů (Bootstrap)
document.addEventListener("DOMContentLoaded", function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// ===== DATA =====
const rows = {{ rows|safe }};
const years = {{ years|safe }};

function getSelectedYears() {
  return Array.from(document.querySelectorAll(".year-filter:checked")).map(cb => parseInt(cb.value));
}
function filterRowsByYears(selectedYears) {
  return rows.filter(r => selectedYears.includes(r.year));
}

let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

function renderCharts() {
  const selectedYears = getSelectedYears();
  const dataRows = filterRowsByYears(selectedYears);
  const labels = dataRows.map(r => r.year);

  // ========================
  // 📈 Váš příběh zisku
  // ========================
  const categories = ["Tržby", "Náklady na prodané zboží", "Hrubá marže", "Provozní náklady", "EBIT", "Čistý zisk"];
  const datasets = dataRows.map((row, idx) => ({
    label: row.year,
    data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
    backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
  }));
  if (profitStoryChart) profitStoryChart.destroy();
  profitStoryChart = new Chart(document.getElementById("profitStoryChart"), {
    type: "bar",
    data: { labels: categories, datasets },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "Váš příběh zisku (Profit Story)",
          font: { size: 18, weight: 'bold' }
        },
        tooltip: {
          callbacks: {
            label: (item) => `${item.label}: ${item.formattedValue.toLocaleString('cs-CZ')} Kč`
          }
        },
        legend: { position: "top" }
      },
      scales: {
        y: {
          title: { display: true, text: "Hodnota (Kč)" },
          ticks: { callback: (v) => v.toLocaleString('cs-CZ') }
        }
      }
    }
  });

  // ========================
  // 📊 Trend ziskovosti
  // ========================
  const datasetsTrends = dataRows.map((row, idx) => ({
    label: row.year,
    data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
    backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
  }));
  if (profitabilityTrendsChart) profitabilityTrendsChart.destroy();
  profitabilityTrendsChart = new Chart(document.getElementById("profitabilityTrendsChart"), {
    type: "bar",
    data: { labels: ["Hrubá marže %", "Provozní marže %", "Čistá marže %"], datasets: datasetsTrends },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Trend ziskovosti", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.label}: ${item.formattedValue}%` } },
        legend: { position: "top" }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // 📈 Růst tržeb vs. COGS
  // ========================
  const revGrowth = dataRows.map(r => r.growth.revenue);
  const cogsGrowth = dataRows.map(r => r.growth.cogs);
  if (revCogsGrowthChart) revCogsGrowthChart.destroy();
  revCogsGrowthChart = new Chart(document.getElementById("revCogsGrowthChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Růst tržeb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
        { label: "Růst nákladů na prodané zboží (%)", data: cogsGrowth, backgroundColor: "rgba(255,99,132,0.7)" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Růst tržeb vs. růst nákladů na prodané zboží", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // 📈 Růst tržeb vs. provozní náklady
  // ========================
  const overheadsGrowth = dataRows.map(r => r.growth.overheads);
  if (revOverheadsGrowthChart) revOverheadsGrowthChart.destroy();
  revOverheadsGrowthChart = new Chart(document.getElementById("revOverheadsGrowthChart"), {
    type: "bar",
    data: {
      labels,
      datasets: [
        { label: "Růst tržeb (%)", data: revGrowth, backgroundColor: "rgba(0,123,255,0.7)" },
        { label: "Růst provozních nákladů (%)", data: overheadsGrowth, backgroundColor: "rgba(255,206,86,0.7)" }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Růst tržeb vs. růst provozních nákladů", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue}%` } }
      },
      scales: { y: { ticks: { callback: (v) => v + "%" } } }
    }
  });

  // ========================
  // 📊 Meziroční přehled (All Metrics)
  // ========================
  if (allMetricsChart) allMetricsChart.destroy();
  allMetricsChart = new Chart(document.getElementById("allMetricsChart"), {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Tržby", data: dataRows.map(r => r.revenue), borderColor: "blue", tension: 0.3 },
        { label: "COGS (náklady na prodané zboží)", data: dataRows.map(r => r.cogs), borderColor: "red", tension: 0.3 },
        { label: "Hrubá marže", data: dataRows.map(r => r.gross_margin), borderColor: "green", tension: 0.3 },
        { label: "Provozní náklady", data: dataRows.map(r => r.overheads), borderColor: "orange", tension: 0.3 },
        { label: "EBIT", data: dataRows.map(r => r.ebit), borderColor: "purple", tension: 0.3 },
        { label: "Čistý zisk", data: dataRows.map(r => r.net_profit), borderColor: "brown", tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: { display: true, text: "Meziroční vývoj hlavních metrik", font: { size: 18, weight: 'bold' } },
        tooltip: { callbacks: { label: (item) => `${item.dataset.label}: ${item.formattedValue.toLocaleString('cs-CZ')} Kč` } },
        legend: { position: "top" }
      },
      scales: {
        y: { ticks: { callback: (v) => v.toLocaleString('cs-CZ') + " Kč" } }
      }
    }
  });
}

document.querySelectorAll(".year-filter").forEach(cb => cb.addEventListener("change", renderCharts));
renderCharts();

// ===== EXPORT FUNKCE =====
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function saveChartAsImage(chart, chartId) {
  if (!chart) return;
  const imageBase64 = chart.toBase64Image();
  fetch("/exports/upload_chart/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ image: imageBase64 })
  })
  .then(r => r.json())
  .then(data => console.log("Graf uložen:", data))
  .catch(e => console.error("Chyba při ukládání grafu:", e));
}

async function saveChartAsImage(chart, chartId) {
  if (!chart) return;
  const imageBase64 = chart.toBase64Image();
  try {
    const response = await fetch("/exports/upload_chart/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ image: imageBase64, chart_id: chartId })
    });
    const data = await response.json();
    console.log("Graf uložen:", data);
    // malá pauza, aby se zápis dokončil
    await new Promise(resolve => setTimeout(resolve, 300));
  } catch (e) {
    console.error("Chyba při ukládání grafu:", e);
  }
}

async function saveAllCharts() {
  const charts = [
    { chart: profitStoryChart, id: "profit_story" },
    { chart: profitabilityTrendsChart, id: "profitability_trends" },
    { chart: revCogsGrowthChart, id: "rev_cogs_growth" },
    { chart: revOverheadsGrowthChart, id: "rev_overheads_growth" },
    { chart: allMetricsChart, id: "all_metrics" }
  ];

  // Ukládáme jeden po druhém
  for (const c of charts) {
    await saveChartAsImage(c.chart, c.id);
  }
  console.log("✅ Všechny grafy uloženy");
}

document.addEventListener("DOMContentLoaded", () => {
  const exportBtn = document.createElement("button");
  exportBtn.textContent = "💾 Uložit grafy do PDF";
  exportBtn.className = "btn btn-primary mt-3";
  exportBtn.onclick = async () => {
    await saveAllCharts();
    // Po dokončení všech uploadů otevřeme PDF export
    window.location.href = "/exports/pdf/";
  };
  document.querySelector(".container").appendChild(exportBtn);
});
</script>
{% endblock %}
