{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>üìä Dashboard</h2>

  <!-- Filtrov√°n√≠ rok≈Ø -->
  <div class="mb-3">
    <strong>Vyber roky:</strong><br>
    {% for r in table_rows %}
      <label class="me-2">
        <input type="checkbox" class="year-filter" value="{{ r.year }}" checked>
        {{ r.year }}
      </label>
    {% endfor %}
  </div>

  <!-- Grafy -->
  <h3>Your Profit Story</h3>
  <canvas id="profitStoryChart"></canvas>

  <h3 class="mt-5">Profitability Trends</h3>
  <canvas id="profitabilityTrendsChart"></canvas>

  <h3 class="mt-5">Revenue Growth vs Cost of Goods Growth</h3>
  <canvas id="revCogsGrowthChart"></canvas>

  <h3 class="mt-5">Revenue Growth vs Overheads Growth</h3>
  <canvas id="revOverheadsGrowthChart"></canvas>

  <!-- Tabulkov√Ω p≈ôehled -->
  <h3 class="mt-5">üìë P≈ôehled dat</h3>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Rok</th>
        <th>Revenue</th>
        <th>COGS</th>
        <th>Gross Margin</th>
        <th>Overheads</th>
        <th>EBIT</th>
        <th>Net Profit</th>
        <th>GM %</th>
        <th>OP %</th>
        <th>NP %</th>
        <th>Revenue Growth %</th>
        <th>COGS Growth %</th>
        <th>Overheads Growth %</th>
      </tr>
    </thead>
    <tbody>
      {% for r in table_rows %}
      <tr>
        <td>{{ r.year }}</td>
        <td>{{ r.revenue }}</td>
        <td>{{ r.cogs }}</td>
        <td>{{ r.gross_margin }}</td>
        <td>{{ r.overheads }}</td>
        <td>{{ r.ebit }}</td>
        <td>{{ r.net_profit }}</td>
        <td>{{ r.profitability.gm_pct|floatformat:2 }}%</td>
        <td>{{ r.profitability.op_pct|floatformat:2 }}%</td>
        <td>{{ r.profitability.np_pct|floatformat:2 }}%</td>
        <td>{{ r.growth.revenue|floatformat:2 }}%</td>
        <td>{{ r.growth.cogs|floatformat:2 }}%</td>
        <td>{{ r.growth.overheads|floatformat:2 }}%</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Line chart pro v≈°echny metriky -->
  <h3 class="mt-5">üìà Year-over-Year Overview (All Metrics)</h3>
  <canvas id="allMetricsChart"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  const rows = {{ rows|safe }};
  const years = {{ years|safe }};

  function getSelectedYears() {
    return Array.from(document.querySelectorAll(".year-filter:checked"))
                .map(cb => parseInt(cb.value));
  }
  function filterRowsByYears(selectedYears) {
    return rows.filter(r => selectedYears.includes(r.year));
  }

  let profitStoryChart, profitabilityTrendsChart, revCogsGrowthChart, revOverheadsGrowthChart, allMetricsChart;

  function renderCharts() {
    const selectedYears = getSelectedYears();
    const dataRows = filterRowsByYears(selectedYears);
    const labels = dataRows.map(r => r.year);

    // Profit Story
    const categories = ["Revenue", "COGS", "Gross Margin", "Overheads", "EBIT", "Net Profit"];
    const datasets = dataRows.map((row, idx) => ({
      label: row.year,
      data: [row.revenue, row.cogs, row.gross_margin, row.overheads, row.ebit, row.net_profit],
      backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
    }));
    if (profitStoryChart) profitStoryChart.destroy();
    profitStoryChart = new Chart(document.getElementById("profitStoryChart"), {
      type: "bar",
      data: { labels: categories, datasets },
      options: { responsive: true, plugins: { legend: { position: "top" } } }
    });

    // Profitability Trends
    const datasetsTrends = dataRows.map((row, idx) => ({
      label: row.year,
      data: [row.profitability.gm_pct, row.profitability.op_pct, row.profitability.np_pct],
      backgroundColor: `hsl(${(idx * 70) % 360},70%,50%)`
    }));
    if (profitabilityTrendsChart) profitabilityTrendsChart.destroy();
    profitabilityTrendsChart = new Chart(document.getElementById("profitabilityTrendsChart"), {
      type: "bar",
      data: { labels: ["Gross Margin %", "Operating Profit %", "Net Profit %"], datasets: datasetsTrends },
      options: { responsive: true, plugins: { legend: { position: "top" } } }
    });

    // Revenue Growth vs COGS Growth
    const revGrowth = dataRows.map(r => r.growth.revenue);
    const cogsGrowth = dataRows.map(r => r.growth.cogs);
    if (revCogsGrowthChart) revCogsGrowthChart.destroy();
    revCogsGrowthChart = new Chart(document.getElementById("revCogsGrowthChart"), {
      type: "bar",
      data: { labels, datasets: [
        { label: "Revenue Growth %", data: revGrowth, backgroundColor: "rgba(75,192,192,0.7)" },
        { label: "COGS Growth %", data: cogsGrowth, backgroundColor: "rgba(255,99,132,0.7)" }
      ] }
    });

    // Revenue Growth vs Overheads Growth
    const overheadsGrowth = dataRows.map(r => r.growth.overheads);
    if (revOverheadsGrowthChart) revOverheadsGrowthChart.destroy();
    revOverheadsGrowthChart = new Chart(document.getElementById("revOverheadsGrowthChart"), {
      type: "bar",
      data: { labels, datasets: [
        { label: "Revenue Growth %", data: revGrowth, backgroundColor: "rgba(75,192,192,0.7)" },
        { label: "Overheads Growth %", data: overheadsGrowth, backgroundColor: "rgba(255,206,86,0.7)" }
      ] }
    });

    // All Metrics Line Chart
    if (allMetricsChart) allMetricsChart.destroy();
    allMetricsChart = new Chart(document.getElementById("allMetricsChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Revenue", data: dataRows.map(r => r.revenue), borderColor: "blue", tension: 0.3 },
          { label: "COGS", data: dataRows.map(r => r.cogs), borderColor: "red", tension: 0.3 },
          { label: "Gross Margin", data: dataRows.map(r => r.gross_margin), borderColor: "green", tension: 0.3 },
          { label: "Overheads", data: dataRows.map(r => r.overheads), borderColor: "orange", tension: 0.3 },
          { label: "EBIT", data: dataRows.map(r => r.ebit), borderColor: "purple", tension: 0.3 },
          { label: "Net Profit", data: dataRows.map(r => r.net_profit), borderColor: "brown", tension: 0.3 }
        ]
      }
    });
  }

  document.querySelectorAll(".year-filter").forEach(cb => cb.addEventListener("change", renderCharts));
  renderCharts();


  // ===== EXPORT FUNKCE =====

  function saveChartAsImage(chart, chartId) {
    if (!chart) return;
    const imageBase64 = chart.toBase64Image();
    fetch("/exports/upload_chart/", {   // ‚¨ÖÔ∏è zmƒõna na exports app
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({
        chart_id: chartId,
        image: imageBase64
      })
    })
    .then(r => r.json())
    .then(data => console.log("Graf ulo≈æen:", data));
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function saveAllCharts() {
    saveChartAsImage(profitStoryChart, "profit_story");
    saveChartAsImage(profitabilityTrendsChart, "profitability_trends");
    saveChartAsImage(revCogsGrowthChart, "rev_cogs_growth");
    saveChartAsImage(revOverheadsGrowthChart, "rev_overheads_growth");
    saveChartAsImage(allMetricsChart, "all_metrics");
  }

  document.addEventListener("DOMContentLoaded", () => {
    const exportBtn = document.createElement("button");
    exportBtn.textContent = "üíæ Ulo≈æit grafy do PDF";
    exportBtn.className = "btn btn-primary mt-3";
    exportBtn.onclick = () => {
      saveAllCharts();
      setTimeout(() => {
        window.location.href = "/exports/pdf/";   // ‚¨ÖÔ∏è zmƒõna na exports app
      }, 1000);
    };
    document.querySelector(".container").appendChild(exportBtn);
  });
</script>
{% endblock %}
