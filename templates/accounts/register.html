{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Registrace novÃ© firmy</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-danger">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <!-- PÅ™ihlaÅ¡ovacÃ­ Ãºdaje -->
    <div class="mb-3">
      <label for="email" class="form-label">E-mail (login)</label>
      <input type="email" class="form-control" id="email" name="email" required>
    </div>

    <div class="mb-3">
      <label for="password" class="form-label">Heslo</label>
      <input type="password" class="form-control" id="password" name="password" required minlength="8">
      <small class="form-text text-muted">Heslo musÃ­ mÃ­t alespoÅˆ 8 znakÅ¯</small>
    </div>

    <div class="mb-3">
      <label for="password2" class="form-label">PotvrzenÃ­ hesla</label>
      <input type="password" class="form-control" id="password2" name="password2" required>
      <div id="password-status" class="mt-2"></div>
    </div>

    <!-- FiremnÃ­ Ãºdaje -->
    <div class="mb-3">
      <label for="company_name" class="form-label">NÃ¡zev firmy</label>
      <input type="text" class="form-control" id="company_name" name="company_name" required>
    </div>

    <div class="mb-3">
      <label for="ico" class="form-label">IÄŒO</label>
      <div class="input-group">
        <input type="text" class="form-control" id="ico" name="ico" required maxlength="8" placeholder="12345678">
        <button type="button" class="btn btn-outline-secondary" id="load-company-btn" disabled>
          <span id="load-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
          ğŸ“‹ NaÄÃ­st Ãºdaje
        </button>
      </div>
      <small class="form-text text-muted">Zadej 8-mÃ­stnÃ© IÄŒO a automaticky se naÄtou Ãºdaje z obchodnÃ­ho rejstÅ™Ã­ku</small>
      <div id="ico-status" class="mt-2"></div>
    </div>

    <div class="mb-3">
      <label for="contact_person" class="form-label">KontaktnÃ­ osoba</label>
      <input type="text" class="form-control" id="contact_person" name="contact_person" required>
    </div>

    <div class="mb-3">
      <label for="phone" class="form-label">Telefon</label>
      <input type="text" class="form-control" id="phone" name="phone" required>
    </div>

    <div class="mb-3">
      <label for="address" class="form-label">Adresa</label>
      <input type="text" class="form-control" id="address" name="address" placeholder="NaÄte se automaticky z IÄŒO">
    </div>

    <div class="row">
      <div class="col-md-8 mb-3">
        <label for="city" class="form-label">MÄ›sto</label>
        <input type="text" class="form-control" id="city" name="city" placeholder="NaÄte se automaticky z IÄŒO">
      </div>
      <div class="col-md-4 mb-3">
        <label for="postal_code" class="form-label">PSÄŒ</label>
        <input type="text" class="form-control" id="postal_code" name="postal_code" placeholder="NaÄte se automaticky z IÄŒO">
      </div>
    </div>

    <div class="mb-3">
      <label for="legal_form" class="form-label">PrÃ¡vnÃ­ forma</label>
      <input type="text" class="form-control" id="legal_form" name="legal_form" placeholder="NaÄte se automaticky z IÄŒO">
    </div>

    <div class="mb-3">
      <label for="industry" class="form-label">OdvÄ›tvÃ­ pÅ¯sobnosti</label>
      <input type="text" class="form-control" id="industry" name="industry" placeholder="NaÄte se automaticky z IÄŒO">
    </div>

    <div class="mb-3">
      <label for="employees_count" class="form-label">PoÄet zamÄ›stnancÅ¯</label>
      <input type="number" class="form-control" id="employees_count" name="employees_count">
    </div>

    <div class="mb-3">
      <label for="linkedin" class="form-label">LinkedIn</label>
      <input type="url" class="form-control" id="linkedin" name="linkedin">
    </div>

    <div class="mb-3">
      <label for="website" class="form-label">WebovÃ© strÃ¡nky</label>
      <input type="url" class="form-control" id="website" name="website">
    </div>

    <!-- PÅ™iÅ™azenÃ½ kouÄ -->
    <div class="mb-3">
      <label for="assigned_coach" class="form-label">PÅ™iÅ™azenÃ½ kouÄ</label>
      <select class="form-select" id="assigned_coach" name="assigned_coach">
        <option value="">-- bez kouÄe --</option>
        {% for coach in coaches %}
          <option value="{{ coach.id }}">{{ coach.user.get_full_name|default:coach.user.username|default:coach.user.email|default:"Nepojmenovany kouc" }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn btn-success">Registrovat</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const icoInput = document.getElementById('ico');
    const loadBtn = document.getElementById('load-company-btn');
    const loadSpinner = document.getElementById('load-spinner');
    const icoStatus = document.getElementById('ico-status');
    
    const passwordInput = document.getElementById('password');
    const password2Input = document.getElementById('password2');
    const passwordStatus = document.getElementById('password-status');
    const submitBtn = document.querySelector('button[type="submit"]');
    
    // Validace IÄŒO pÅ™i psanÃ­
    icoInput.addEventListener('input', function() {
        const ico = this.value.trim();
        
        // PovolÃ­ pouze ÄÃ­slice
        this.value = ico.replace(/\D/g, '');
        
        if (this.value.length === 8) {
            loadBtn.disabled = false;
            icoStatus.innerHTML = '<small class="text-success">âœ… IÄŒO mÃ¡ sprÃ¡vnÃ½ formÃ¡t</small>';
        } else {
            loadBtn.disabled = true;
            if (this.value.length > 0) {
                icoStatus.innerHTML = '<small class="text-warning">âš ï¸ IÄŒO musÃ­ mÃ­t 8 ÄÃ­slic</small>';
            } else {
                icoStatus.innerHTML = '';
            }
        }
    });
    
    // NaÄtenÃ­ dat pÅ™i stisku tlaÄÃ­tka
    loadBtn.addEventListener('click', async function() {
        const ico = icoInput.value.trim();
        
        if (ico.length !== 8) {
            alert('IÄŒO musÃ­ obsahovat pÅ™esnÄ› 8 ÄÃ­slic');
            return;
        }
        
        // Zobraz loading
        loadBtn.disabled = true;
        loadSpinner.classList.remove('d-none');
        icoStatus.innerHTML = '<small class="text-info">ğŸ”„ NaÄÃ­tÃ¡m Ãºdaje z obchodnÃ­ho rejstÅ™Ã­ku...</small>';
        
        try {
            const response = await fetch(`/accounts/api/company-data/?ico=${ico}`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // VyplÅˆ formulÃ¡Å™ daty z API
                const companyData = data.data;
                
                if (companyData.company_name) {
                    document.getElementById('company_name').value = companyData.company_name;
                }
                
                if (companyData.address) {
                    document.getElementById('address').value = companyData.address;
                }
                
                if (companyData.city) {
                    document.getElementById('city').value = companyData.city;
                }
                
                if (companyData.postal_code) {
                    document.getElementById('postal_code').value = companyData.postal_code;
                }
                
                if (companyData.legal_form) {
                    document.getElementById('legal_form').value = companyData.legal_form;
                }
                
                if (companyData.industry) {
                    document.getElementById('industry').value = companyData.industry;
                }
                
                // Zobraz ÃºspÄ›ch
                icoStatus.innerHTML = `
                    <div class="alert alert-success alert-sm mt-2">
                        âœ… Ãšdaje ÃºspÄ›Å¡nÄ› naÄteny z registru ARES
                        <br><small>Zkontroluj a pÅ™Ã­padnÄ› uprav naÄtenÃ© Ãºdaje</small>
                    </div>
                `;
                
                // AktivnÃ­/neaktivnÃ­ firma
                if (companyData.active === false) {
                    icoStatus.innerHTML += '<div class="alert alert-warning alert-sm">âš ï¸ Pozor: Firma nenÃ­ aktivnÃ­ v obchodnÃ­m rejstÅ™Ã­ku</div>';
                }
                
            } else {
                // Zobraz chybu
                icoStatus.innerHTML = `
                    <div class="alert alert-danger alert-sm mt-2">
                        âŒ ${data.error}
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading company data:', error);
            icoStatus.innerHTML = `
                <div class="alert alert-danger alert-sm mt-2">
                    âŒ Chyba pÅ™i naÄÃ­tÃ¡nÃ­ dat: ${error.message}
                </div>
            `;
        } finally {
            // Skryj loading
            loadSpinner.classList.add('d-none');
            loadBtn.disabled = false;
        }
    });
    
    // Enter key v IÄŒO poli spustÃ­ naÄÃ­tÃ¡nÃ­
    icoInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !loadBtn.disabled) {
            e.preventDefault();
            loadBtn.click();
        }
    });
    
    // Validace hesla
    function validatePasswords() {
        const password = passwordInput.value;
        const password2 = password2Input.value;
        
        // Reset stavu
        passwordInput.classList.remove('is-valid', 'is-invalid');
        password2Input.classList.remove('is-valid', 'is-invalid');
        passwordStatus.innerHTML = '';
        
        // Validace dÃ©lky hesla
        if (password.length > 0) {
            if (password.length < 8) {
                passwordInput.classList.add('is-invalid');
                passwordStatus.innerHTML = '<small class="text-danger">âŒ Heslo musÃ­ mÃ­t alespoÅˆ 8 znakÅ¯</small>';
                return false;
            } else {
                passwordInput.classList.add('is-valid');
            }
        }
        
        // Validace shody hesel
        if (password2.length > 0) {
            if (password !== password2) {
                password2Input.classList.add('is-invalid');
                passwordStatus.innerHTML = '<small class="text-danger">âŒ Hesla se neshodujÃ­</small>';
                return false;
            } else if (password.length >= 8) {
                password2Input.classList.add('is-valid');
                passwordStatus.innerHTML = '<small class="text-success">âœ… Hesla se shodujÃ­</small>';
                return true;
            }
        }
        
        return password.length >= 8 && password === password2;
    }
    
    // Event listenery pro hesla
    passwordInput.addEventListener('input', validatePasswords);
    password2Input.addEventListener('input', validatePasswords);
    
    // Kontrola pÅ™ed odeslÃ¡nÃ­m formulÃ¡Å™e
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        if (!validatePasswords()) {
            e.preventDefault();
            alert('Zkontroluj prosÃ­m hesla pÅ™ed odeslÃ¡nÃ­m formulÃ¡Å™e.');
            return false;
        }
        
        const password = passwordInput.value;
        const password2 = password2Input.value;
        
        if (password !== password2) {
            e.preventDefault();
            alert('Hesla se neshodujÃ­!');
            return false;
        }
        
        if (password.length < 8) {
            e.preventDefault();
            alert('Heslo musÃ­ mÃ­t alespoÅˆ 8 znakÅ¯!');
            return false;
        }
    });
});
</script>

{% endblock %}
