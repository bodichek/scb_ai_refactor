{% extends "base.html" %}

{% block extra_head %}
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      corePlugins: {
        preflight: false,
      },
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    @keyframes slide-up {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .slide-up {
      animation: slide-up 0.4s ease-out;
    }

    .spin-slow {
      animation: spin-slow 2s linear infinite;
    }

    .fade-in {
      animation: fade-in 0.3s ease-in;
    }

    .progress-bar-animated {
      transition: width 0.5s ease-out;
    }

    /* File drop zone hover effect */
    .file-drop-zone {
      transition: all 0.3s ease;
      position: relative;
    }

    .file-drop-zone:hover {
      border-color: rgb(14 165 233);
      background-color: rgb(240 249 255);
    }

    .file-drop-zone.drag-over {
      border-color: rgb(2 132 199);
      background-color: rgb(224 242 254);
      transform: scale(1.02);
    }

    .file-drop-zone.uploading {
      pointer-events: none;
      opacity: 0.95;
    }
  </style>
{% endblock %}

{% block content %}
<div class="min-h-[calc(100vh-140px)] bg-gradient-to-b from-sky-50/60 via-white to-slate-100 py-10">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
    <section class="dashboard-card bg-white/95 border border-slate-200/70 rounded-3xl shadow-lg shadow-slate-900/5 p-6 space-y-6">
      <div class="space-y-2">
        <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Ingest</p>
        <h1 class="text-2xl font-semibold text-slate-900">Nahrat novy financni vykaz</h1>
        <p class="text-sm text-slate-500">Vyber PDF s vysledovkou nebo rozvahou. Analyzu spustime automaticky.</p>
      </div>

      <!-- Upload Form -->
      <form method="post" enctype="multipart/form-data" class="space-y-6" id="uploadForm">
        {% csrf_token %}
        <div class="flex flex-col gap-2">
          <label for="year" class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Rok</label>
          <select name="year" id="year" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm text-slate-700 focus:border-sky-500 focus:ring-sky-500" required>
            {% for y in years %}
              <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- File Drop Zone with Integrated Progress -->
        <div class="flex flex-col gap-2">
          <label for="pdf_file" class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">Soubor PDF</label>
          <div class="file-drop-zone rounded-xl border-2 border-dashed border-slate-300 bg-slate-50/50 overflow-hidden" id="dropZone">
            <input type="file" name="pdf_file" id="pdf_file" accept="application/pdf" class="hidden" required>

            <!-- Normal State -->
            <div id="dropZoneContent" class="p-8 text-center cursor-pointer">
              <svg class="mx-auto h-12 w-12 text-slate-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p class="text-sm font-medium text-slate-700 mb-1">Klikni nebo pretahni PDF soubor</p>
              <p class="text-xs text-slate-500">Maximalni velikost: 10 MB</p>
            </div>

            <!-- Selected File State -->
            <div id="selectedFileState" class="hidden p-6 cursor-pointer">
              <div class="flex items-center gap-3">
                <div class="flex-shrink-0 w-10 h-10 bg-sky-100 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-sky-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p id="selectedFileName" class="text-sm font-medium text-slate-900 truncate"></p>
                  <p id="selectedFileSize" class="text-xs text-slate-500"></p>
                </div>
              </div>
            </div>

            <!-- Upload Progress State -->
            <div id="uploadingState" class="hidden">
              <!-- Progress Bar at Bottom -->
              <div class="relative h-2 bg-slate-200">
                <div id="progressBar" class="absolute inset-0 bg-gradient-to-r from-sky-500 to-blue-600 progress-bar-animated" style="width: 0%"></div>
              </div>

              <!-- Upload Info -->
              <div class="p-6">
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-sky-100 rounded-lg flex items-center justify-center">
                      <svg class="w-5 h-5 text-sky-600 spin-slow" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                    </div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-2">
                      <p id="uploadFileName" class="text-sm font-medium text-slate-900 truncate"></p>
                      <span id="progressPercent" class="text-sm font-bold text-sky-600 ml-3">0%</span>
                    </div>
                    <p id="currentStageText" class="text-xs text-slate-600 mb-3">Pripravuji se...</p>

                    <!-- Status Messages -->
                    <div id="statusMessages" class="space-y-1.5">
                      <!-- Status items will be added here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <button type="submit" id="submitBtn" class="inline-flex items-center gap-2 rounded-xl bg-sky-600 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-sky-600/30 hover:bg-sky-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="submitBtnText">Nahrat a analyzovat</span>
          </button>
        </div>
      </form>
    </section>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('uploadForm');
  const fileInput = document.getElementById('pdf_file');
  const dropZone = document.getElementById('dropZone');
  const dropZoneContent = document.getElementById('dropZoneContent');
  const selectedFileState = document.getElementById('selectedFileState');
  const selectedFileName = document.getElementById('selectedFileName');
  const selectedFileSize = document.getElementById('selectedFileSize');
  const uploadingState = document.getElementById('uploadingState');
  const uploadFileName = document.getElementById('uploadFileName');
  const submitBtn = document.getElementById('submitBtn');
  const submitBtnText = document.getElementById('submitBtnText');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const statusMessages = document.getElementById('statusMessages');
  const currentStageText = document.getElementById('currentStageText');

  // File drop zone click handler
  dropZone.addEventListener('click', function(e) {
    if (!dropZone.classList.contains('uploading')) {
      fileInput.click();
    }
  });

  // File selection handler
  fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      selectedFileName.textContent = file.name;
      selectedFileSize.textContent = formatFileSize(file.size);

      // Show selected file state
      dropZoneContent.classList.add('hidden');
      selectedFileState.classList.remove('hidden');
      uploadingState.classList.add('hidden');
    }
  });

  // Drag and drop handlers
  dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (!this.classList.contains('uploading')) {
      this.classList.add('drag-over');
    }
  });

  dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('drag-over');
  });

  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    e.stopPropagation();
    this.classList.remove('drag-over');

    if (this.classList.contains('uploading')) return;

    const files = e.dataTransfer.files;
    if (files && files[0]) {
      if (files[0].type === 'application/pdf') {
        fileInput.files = files;
        const event = new Event('change');
        fileInput.dispatchEvent(event);
      } else {
        alert('Prosim, nahrajte pouze PDF soubory.');
      }
    }
  });

  // Form submission with progress tracking
  form.addEventListener('submit', function(e) {
    e.preventDefault();

    if (!fileInput.files || !fileInput.files[0]) {
      alert('Prosim, vyberte soubor.');
      return;
    }

    const file = fileInput.files[0];
    const formData = new FormData(form);

    // Switch to uploading state
    dropZoneContent.classList.add('hidden');
    selectedFileState.classList.add('hidden');
    uploadingState.classList.remove('hidden');
    dropZone.classList.add('uploading');

    uploadFileName.textContent = file.name;
    submitBtn.disabled = true;
    submitBtnText.textContent = 'Nahravani...';

    // Reset progress
    statusMessages.innerHTML = '';
    updateProgress(0, 'Pripravuji nahravani...');

    // Create XMLHttpRequest for upload progress tracking
    const xhr = new XMLHttpRequest();

    // Upload progress
    xhr.upload.addEventListener('progress', function(e) {
      if (e.lengthComputable) {
        const percentComplete = Math.round((e.loaded / e.total) * 25); // 0-25%
        updateProgress(percentComplete, 'Nahravam soubor na server...');
      }
    });

    // State change handler
    xhr.addEventListener('readystatechange', function() {
      if (xhr.readyState === XMLHttpRequest.OPENED) {
        addStatusMessage('Pripojuji se k serveru...', 'pending');
      }
      if (xhr.readyState === XMLHttpRequest.HEADERS_RECEIVED) {
        updateProgress(25, 'Soubor nahran, spoustim analyzu...');
        addStatusMessage('Soubor uspesne nahran', 'success');
      }
    });

    // Load handler (response received)
    xhr.addEventListener('load', function() {
      if (xhr.status === 200 || xhr.status === 302) {
        simulateProcessing();
      } else {
        showError('Chyba pri nahravani. Zkuste to prosim znovu.');
      }
    });

    // Error handler
    xhr.addEventListener('error', function() {
      showError('Chyba pripojeni. Zkontrolujte internetove pripojeni.');
    });

    // Abort handler
    xhr.addEventListener('abort', function() {
      showError('Nahravani bylo preruseno.');
    });

    // Send request
    xhr.open('POST', form.action || window.location.href);
    xhr.send(formData);
  });

  // Simulate processing stages
  function simulateProcessing() {
    const stages = [
      { progress: 40, text: 'Konvertuji PDF na obrazek...', delay: 800 },
      { progress: 60, text: 'Odesilam na AI analyzu (Claude Vision)...', delay: 1500 },
      { progress: 85, text: 'Zpracovavam financni data...', delay: 2000 },
      { progress: 95, text: 'Ukladam vysledky do databaze...', delay: 500 },
      { progress: 100, text: 'Hotovo!', delay: 300 }
    ];

    let currentStage = 0;

    function processNextStage() {
      if (currentStage < stages.length) {
        const stage = stages[currentStage];

        setTimeout(() => {
          updateProgress(stage.progress, stage.text);

          if (stage.progress === 40) {
            addStatusMessage('PDF konvertovano (300 DPI)', 'success');
          } else if (stage.progress === 60) {
            addStatusMessage('Cekam na AI odpoved...', 'pending');
          } else if (stage.progress === 85) {
            addStatusMessage('AI analyza dokoncena', 'success');
          } else if (stage.progress === 95) {
            addStatusMessage('Data validovana', 'success');
          } else if (stage.progress === 100) {
            addStatusMessage('Uspesne ulozeno', 'success');
            setTimeout(() => {
              window.location.reload();
            }, 500);
          }

          currentStage++;
          processNextStage();
        }, stage.delay);
      }
    }

    processNextStage();
  }

  function updateProgress(percent, stageText) {
    progressBar.style.width = percent + '%';
    progressPercent.textContent = percent + '%';
    currentStageText.textContent = stageText;
  }

  function addStatusMessage(text, status) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'flex items-center gap-2 text-xs fade-in';

    let icon = '';
    let colorClass = '';

    if (status === 'success') {
      icon = '<svg class="h-3.5 w-3.5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>';
      colorClass = 'text-green-700';
    } else if (status === 'pending') {
      icon = '<svg class="h-3.5 w-3.5 text-blue-500 flex-shrink-0 spin-slow" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      colorClass = 'text-blue-700';
    } else {
      icon = '<svg class="h-3.5 w-3.5 text-red-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>';
      colorClass = 'text-red-700';
    }

    messageDiv.innerHTML = `${icon}<span class="${colorClass}">${text}</span>`;
    statusMessages.appendChild(messageDiv);
  }

  function showError(message) {
    updateProgress(0, 'Chyba');
    addStatusMessage(message, 'error');
    submitBtn.disabled = false;
    submitBtnText.textContent = 'Zkusit znovu';
    dropZone.classList.remove('uploading');
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }
})();
</script>
{% endblock %}
