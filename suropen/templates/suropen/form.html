{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mb-4">🔎 Osobní analýza</h2>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  {% if just_submitted %}
    <div class="alert alert-success">✅ Dotazník byl úspěšně odeslán.</div>
  {% elif duplicate %}
    <div class="alert alert-warning">⚠️ Odpověď byla již nedávno odeslána, počkej prosím pár sekund.</div>
  {% endif %}

  <form method="post" class="card p-4 shadow-sm">
    {% csrf_token %}
    {% for block in questions %}
      <div class="mb-5">
        <h4 class="text-primary">{{ block.section }}</h4>
        {% for q in block.items %}
          <div class="mb-3">
            <label class="form-label fw-bold">{{ q }}</label>
            <textarea name="q-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}" 
                      rows="3" class="form-control" placeholder="Tvoje odpověď..."></textarea>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
    <button type="submit" class="btn btn-success">Odeslat</button>
  </form>

  {% if ai_text %}
    <div class="card mt-5 p-4 bg-light">
      <h4>🧠 Shrnutí od AI</h4>
      <pre style="white-space: pre-wrap;">{{ ai_text }}</pre>
    </div>
  {% endif %}

  {% if submissions %}
    <div class="card mt-5 p-3">
      <h3>📊 Moje předchozí analýzy</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Datum</th>
            <th>Počet odpovědí</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody>
          {% for s in submissions %}
            <tr>
              <td>{{ s.created_at|date:"d.m.Y H:i" }}</td>
              <td>
                {{ s.count|default:"—" }}
              </td>
              <td>
                <a href="{% url 'suropen:history' %}?batch={{ s.batch_id }}" class="btn btn-sm btn-primary">
                  Zobrazit detail
                </a>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="text-muted">Zatím nemáš žádné záznamy.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.querySelector("form");
  form.addEventListener("submit", () => {
    const btn = form.querySelector("button[type=submit]");
    if (btn) {
      btn.disabled = true;
      btn.innerText = "Odesílám...";
    }
  });
});
</script>
{% endblock %}
